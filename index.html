<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limited Time Offer!</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'YOUR_FACEBOOK_PIXEL_ID'); 
      fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=YOUR_FACEBOOK_PIXEL_ID&ev=PageView&noscript=1"/></noscript>
    
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; background-size: cover; background-position: center; background-attachment: fixed; }
        body[data-theme="light"], body { --color-urgent: #ef4444; --color-accent: #4f46e5; --color-accent-hover: #4338ca; --color-accent-border: #4f46e5; }
        body[data-theme="dark"] { --color-urgent: #d946ef; --color-accent: #ec4899; --color-accent-hover: #db2777; --color-accent-border: #ec4899; }
        .timer-box { background-color: var(--color-urgent); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
        .add-to-cart-button { background-color: var(--color-accent); transition: background-color 0.3s; }
        .add-to-cart-button:hover { background-color: var(--color-accent-hover); }
        .text-highlight { color: var(--color-accent); }
        #cart-panel { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background-color: white; box-shadow: -10px 0 30px rgba(0,0,0,0.1); z-index: 110; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; }
        #cart-panel.open { right: 0; }
        #cart-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 105; }
        #cart-overlay.open { display: block; }
        .modal { display: none; position: fixed; z-index: 120; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 2% auto; padding: 2rem; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; max-height: 90vh; overflow-y: auto;}
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #social-proof-popup { display: none; position: fixed; bottom: 20px; left: 20px; background-color: white; color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 200; opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s; }
        #social-proof-popup.show { display: block; opacity: 1; transform: translateY(0); }
        #public-cart-button { position: fixed; bottom: 20px; right: 20px; background-color: var(--color-accent); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 100; transition: transform 0.2s; }
        #public-cart-button:hover { transform: scale(1.1); }
        #public-cart-badge { position: absolute; top: -5px; right: -5px; background-color: var(--color-urgent); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        #product-sidebar { position: fixed; top: 0; left: 0; width: 240px; height: 100%; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 90; padding-top: 100px; overflow-y: auto; box-shadow: 2px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s; }
        #product-sidebar.show { transform: translateX(0); }
    </style>
</head>
<body data-theme="dark">

    <div id="product-sidebar"><div id="sidebar-content" class="p-4 space-y-4"></div></div>
    <div id="public-cart-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg><span id="public-cart-badge">0</span></div>
    <div id="social-proof-popup"></div>
    <div id="cart-overlay"></div>
    <div id="admin-panel" class="bg-gray-800 text-white p-4 fixed top-0 left-0 w-full z-50 shadow-lg" style="display: none;"><div class="container mx-auto flex flex-wrap justify-between items-center gap-y-2"><div class="flex items-center gap-x-4"><img id="admin-logo-white" src="https://i.imgur.com/7B5NkbX.png" alt="Brand Logo" class="h-8"><div class="flex items-center space-x-2"><input type="text" id="background-url-input" placeholder="Enter background image URL" class="bg-gray-700 text-white text-sm rounded-l-md p-2 w-48"><button id="set-background-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-r-md text-sm">Set</button></div></div><div class="flex flex-wrap items-center gap-x-4 gap-y-2"><div class="flex items-center space-x-2"><label class="switch"><input type="checkbox" id="toggle-sidebar"><span class="slider round"></span></label><span>Sidebar</span></div><div class="flex items-center space-x-2 bg-gray-700 p-2 rounded-md"><select id="timer-mode-select" class="bg-gray-700 text-white text-sm rounded-l-md p-1"><option value="refresh">Timer: Refresh on Load</option><option value="actual">Timer: Actual End Date</option></select><input type="datetime-local" id="timer-actual-date" class="bg-gray-600 text-white text-sm p-1 rounded-r-md" style="display:none;"></div><button id="save-settings-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">Save Settings</button><div class="flex items-center space-x-2 bg-gray-700 rounded-md"><select id="product-switcher" class="bg-gray-700 text-white rounded-l-md p-2 border-r border-gray-600"></select><button id="set-default-btn" class="px-3 py-2 text-sm hover:bg-indigo-500">Set Default</button><button id="edit-product-btn" class="px-3 py-2 text-sm hover:bg-gray-600">Edit</button><button id="delete-product-btn" class="px-3 py-2 text-sm hover:bg-red-500 rounded-r-md">Delete</button></div><div><button id="add-product-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Add New Product</button></div><button id="hide-admin-btn" class="ml-2 text-sm text-gray-400 hover:text-white">Hide</button><button id="logout-btn" class="ml-2 text-sm text-gray-400 hover:text-white">Logout</button></div></div></div>
    <div id="cart-panel"><div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-bold">Your Cart</h2><button id="close-cart-btn" class="text-2xl">&times;</button></div><div class="p-4 bg-yellow-100 text-center"><p class="font-semibold text-yellow-800">Your items are reserved for <span id="cart-timer" class="font-bold">10:00</span>!</p></div><div id="cart-items-container" class="flex-grow p-4 overflow-y-auto"></div><div class="p-4 border-t space-y-4"><div class="flex justify-between font-bold text-lg"><span>Subtotal</span><span id="cart-subtotal">$0.00</span></div><p class="text-sm text-gray-500 text-center">Free Shipping on all orders!</p><button id="checkout-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg">Pay with Card</button></div></div>
    <div id="theme-wrapper"><div id="page-container" class=""><header class="py-4 absolute top-0 left-0 w-full z-10"><div class="container mx-auto px-4 flex justify-center"><img id="header-logo" alt="Brand Logo" class="h-10"></div></header><div class="container mx-auto p-4 max-w-5xl pt-20"><div class="bg-red-600 text-white text-center p-3 rounded-lg shadow-lg timer-box mb-6"><h1 class="text-2xl font-bold">FLASH SALE! Ends In:</h1><div id="countdown-timer" class="text-4xl font-mono tracking-widest mt-2">00:00:00</div></div><div id="urgent-cta" class="text-center mb-6"><h3 id="cta-headline" class="text-2xl font-bold text-highlight animate-pulse">Build Your Bundle & Save Big!</h3><p id="cta-subheadline" class="text-gray-500">Select up to 3 masks to unlock massive discounts!</p></div><div class="bg-white rounded-xl shadow-2xl overflow-hidden md:flex"><div id="media-container" class="md:w-1/2 p-4"><div id="main-product-video-container" class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden hidden"></div><img id="main-product-image" class="w-full aspect-square object-cover rounded-lg shadow-md" src="" alt="Main Product Image"><div id="thumbnail-container" class="grid grid-cols-4 gap-2 mt-4"></div></div><div id="product-details-container" class="p-8 md:w-1/2 flex flex-col justify-between"><div><div id="product-badge" class="uppercase tracking-wide text-sm text-highlight font-semibold"></div><h2 id="product-name" class="text-3xl font-bold text-gray-900 mt-2"></h2><p id="product-description" class="mt-4 text-gray-600"></p><div class="mt-6 flex items-baseline gap-4"><div><span class="text-gray-500 text-sm">Total Price</span><span id="product-price" class="text-4xl font-bold text-gray-900"></span></div><div><span class="text-gray-500 text-sm">Was</span><span id="product-original-price" class="text-xl text-gray-500 line-through"></span></div></div><div id="variations-container" class="mt-6 space-y-4"></div><div id="interactive-bundle-selector" class="mt-6 space-y-3" style="display: none;"></div><div id="bundle-summary" class="mt-4 space-y-2" style="display: none;"><h4 class="font-bold text-lg text-gray-800">Your Bundle:</h4><div id="bundle-summary-items" class="text-gray-600"></div></div><div id="stock-indicator" class="mt-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md stock-alert"><p class="font-bold">Hurry! Only <span id="stock-count">1</span> left in stock!</p></div><div class="mt-2 text-sm text-gray-500"><p><strong class="text-green-600">+15</strong> people have this in their cart right now!</p></div></div><div class="mt-8"><button id="add-to-cart-button" class="add-to-cart-button w-full text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg">Add to Cart</button><div class="flex justify-center items-center mt-4 space-x-4"><p class="text-sm text-gray-500">Secure Payments:</p><svg class="h-8" viewBox="0 0 120 48" xmlns="http://www.w3.org/2000/svg"><path d="M11.5 17.8h2.3l2.3-10.4h.1l2.3 10.4h2.2l3.6-14.8h-2.5l-2.4 10.2h-.1L19.2 3h-2.4l-3.2 12.3-1.1-5.1h-.1l-1.1 5.1-3.2-12.3H5.8l3.6 14.8h2.1zm21.3 0h3.2l-3.2-14.8h-3.2zm-.1-1.6l1.1-5.1h.1l1.1 5.1zm11.3 1.6h2.2l3.6-14.8h-2.4l-2.4 10.2h-.1l-2.3-10.2h-2.4l3.6 14.8h.1zm12 0h3.3c3.2 0 4.9-1.5 4.9-4.2 0-1.8-1-3-2.6-3.6l2.3-7h-2.6l-2 6.3h-1.6v-6.3h-2.2v14.8zm3.2-6.5h1.3c1.4 0 2 .5 2 2 0 1.2-.6 1.8-2 1.8h-1.3v-3.8zm11.4 6.5h2.1l2.1-10.3h.1l2.1 10.3h2.1l3.5-14.8h-2.3l-2.3 10.2h-.1L73 3h-2.3l-3.2 12.3-1.1-5.1h-.1l-1.1 5.1-3.2-12.3H59l3.5 14.8h2.1zm19.1-15.1c-2.3 0-4.3 2-4.3 4.9s2 4.8 4.3 4.8 4.3-2 4.3-4.8-2-4.9-4.3-4.9zm0 8c-1.3 0-2.1-.9-2.1-3.1s.8-3.1 2.1-3.1 2.1.9 2.1 3.1-.8 3.1-2.1 3.1zm6.3-8h-1.6v10.1h1.6zm4.6 0v10.1h1.6V4.6c.7-.3 1.2-.8 1.2-1.6s-.5-1.3-1.2-1.6V0h-1.6v1.1c-.7.3-1.2.8-1.2 1.6s.5 1.3 1.2 1.6zm6.8-1.1c-1.2 0-2 .6-2 1.6v.3h3.9v-.3c0-1-.8-1.6-2-1.6zm-.1 11.2h1.6v-8.6h-1.6zm-2.1-8.6H98v-1.6h3.9v1.6zM0 0h120v48H0z" fill="#000"/></svg><svg class="h-8" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg></div></div></div></div><div id="perks-section" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-lg shadow-md flex items-center"><svg class="h-10 w-10 text-highlight" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><div class="ml-4"><h3 class="text-lg font-semibold">Limited Time Offer</h3><p class="text-gray-600">50% off ends today!</p></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center"><svg class="h-10 w-10 text-highlight" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div class="ml-4"><h3 class="text-lg font-semibold">Satisfaction Guaranteed</h3><p class="text-gray-600">30-day money-back guarantee.</p></div></div></div><div class="mt-12 space-y-8"><div id="shipping-section" class="bg-white p-8 rounded-lg shadow-md"><h3 class="text-2xl font-bold mb-4">Shipping Information</h3><p class="text-gray-700">We offer FREE worldwide express shipping on all orders! Your order will be processed within 24 hours and delivered to your doorstep in 3-5 business days. You'll receive a tracking number as soon as it ships. We've got you covered!</p></div><div id="reviews-section" class="bg-white p-8 rounded-lg shadow-md"><h3 class="text-2xl font-bold mb-4">What Our Customers Say</h3><div id="review-container" class="space-y-6"></div></div></div></div></div></div>
    <div id="add-to-cart-popup" class="modal"><div class="modal-content text-center max-w-md"><span class="close-modal" id="close-popup-btn">&times;</span><h3 class="text-2xl font-bold text-green-600 mb-4">Successfully Added!</h3><img id="popup-product-image" src="" alt="Product Image" class="w-32 h-32 object-cover mx-auto rounded-lg mb-4"><p id="popup-message" class="text-gray-700 mb-6"></p><div class="space-y-3"><button id="popup-view-cart" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">View Cart & Checkout</button><button id="popup-continue-shopping" class="w-full text-gray-600 hover:text-indigo-600 font-semibold py-2">Continue Shopping</button></div></div></div>
    <div id="admin-password-modal" class="modal"><div class="modal-content max-w-sm text-center"><h2 class="text-xl font-bold mb-4">Admin Access</h2><p class="text-gray-600 mb-4">Please enter the password to access admin controls.</p><input type="password" id="admin-password-input" class="w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 mb-4"><p id="admin-password-error" class="text-red-500 text-sm mb-4" style="display: none;">Incorrect password. Please try again.</p><button id="admin-password-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Login</button></div></div>
    <div id="product-modal" class="modal"><div class="modal-content"><span class="close-modal close-product-modal">&times;</span><h2 id="product-modal-title" class="text-2xl font-bold mb-6 text-gray-800"></h2><form id="product-form"><input type="hidden" id="edit-product-key"><div class="space-y-6"><div><label for="product-form-name" class="block text-sm font-medium text-gray-700">Product Name</label><input type="text" id="product-form-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div><div><label for="product-form-description" class="block text-sm font-medium text-gray-700">Description</label><textarea id="product-form-description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></textarea></div><div><label class="block text-sm font-medium text-gray-700">Media Type</label><select id="product-form-media-type" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="image">Image</option><option value="video">Video (YouTube URL)</option></select></div><div id="media-upload-container"><label for="product-form-media-file" class="block text-sm font-medium text-gray-700">Main Image File</label><input type="file" id="product-form-media-file" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"></div><div id="media-url-container" style="display: none;"><label for="product-form-media-url" class="block text-sm font-medium text-gray-700">YouTube URL</label><input type="text" id="product-form-media-url" placeholder="https://..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="product-form-price" class="block text-sm font-medium text-gray-700">Base Sale Price</label><input type="text" id="product-form-price" placeholder="$29.95" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div><div><label for="product-form-original-price" class="block text-sm font-medium text-gray-700">Original Price</label><input type="text" id="product-form-original-price" placeholder="$45.00" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div></div><div><label for="product-form-theme" class="block text-sm font-medium text-gray-700">Product Theme</label><select id="product-form-theme" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="light">Light Theme</option><option value="dark">Dark Theme</option></select></div><div><label for="product-form-bundle" class="flex items-center text-sm font-medium text-gray-700"><input type="checkbox" id="product-form-bundle" class="h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">Is this a special bundle deal product?</label></div><div id="bundle-options-container" class="space-y-4 pt-4 border-t" style="display: none;"><h4 class="text-md font-medium text-gray-800">Bundle Pricing & Text</h4><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><label for="product-form-bundle-price1" class="block text-sm font-medium text-gray-700">Price for 1st item</label><input type="text" id="product-form-bundle-price1" placeholder="$29.95" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div><label for="product-form-bundle-price2" class="block text-sm font-medium text-gray-700">Price for 2nd item</label><input type="text" id="product-form-bundle-price2" placeholder="$24.95" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div><label for="product-form-bundle-price3" class="block text-sm font-medium text-gray-700">Price for 3rd+ item</label><input type="text" id="product-form-bundle-price3" placeholder="$14.95" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div></div><div><label for="product-form-cta-headline" class="block text-sm font-medium text-gray-700">Bundle CTA Headline</label><input type="text" id="product-form-cta-headline" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div><div><label for="product-form-cta-subheadline" class="block text-sm font-medium text-gray-700">Bundle CTA Subheadline</label><input type="text" id="product-form-cta-subheadline" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div></div><div class="border-t pt-4"><h4 class="text-md font-medium text-gray-800 mb-2">Product Variations</h4><div id="product-form-variations-container" class="space-y-4"></div><button type="button" id="add-variation-btn" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-semibold">+ Add Variation Type</button></div><div class="border-t pt-4 mt-4"><button id="product-form-submit" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg shadow-lg">Save Product</button></div></div></form></div></div>
    <footer class="bg-gray-800 text-white mt-12 py-8"><div class="container mx-auto text-center space-y-4"><img id="footer-logo-white" src="https://i.imgur.com/7B5NkbX.png" alt="Brand Logo" class="h-12 mx-auto"><div class="flex justify-center items-center space-x-4 text-sm text-gray-500"><p>&copy; 2025 All These Flows. All Rights Reserved.</p><span>|</span><a href="#" id="admin-login-link" class="hover:text-gray-300">Terms</a></div></div></footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIG ---
    const LOGO_URL_WHITE = 'https://i.imgur.com/7B5NkbX.png';
    const LOGO_URL_BLACK = 'https://i.imgur.com/mY9JuRX.png';
    const STRIPE_PUBLISHABLE_KEY = 'YOUR_PUBLISHABLE_KEY_HERE'; 
    const CHECKOUT_SESSION_URL = 'YOUR_VERCEL_URL_HERE';
    const PRODUCTS_API_URL = '/api/products';
    const UPLOAD_API_URL = '/api/upload';
    
    // --- STATE ---
    let products = {}, reviews = {}, cart = [], currentProductKey = null, settings = {}, cartTimerInterval = null;
    const appStateKey = 'urgentLandingPageState_v15';
    const settingsStateKey = 'urgentLandingPageSettings';
    const initialProducts = { product1: { name: 'Your First Product', description: 'Edit this product from the admin panel.', price: '$19.99', originalPrice: '$25.00', theme: 'light', mediaType: 'image', mediaUrl: 'https://placehold.co/600x600/ccc/ffffff?text=My+Product', images: [], variations: { 'Size': [{ option: 'M' }] }, bundle: false } };
    const initialReviews = { product1: [ { rating: 5, title: "Works Great!", text: "This is exactly what I needed.", author: "Jane D." } ] };

    // --- DOM ELEMENTS ---
    const dom = new Proxy({}, { get: (_, id) => document.getElementById(id.replace(/([A-Z])/g, "-$1").toLowerCase()) });

    // --- DATA & STATE FUNCTIONS ---
    async function saveState() {
      try {
        await fetch(PRODUCTS_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ products }) });
        localStorage.setItem(appStateKey, JSON.stringify({ cart }));
      } catch (error) { console.error("Failed to save products:", error); }
    }
    function saveSettings() {
        localStorage.setItem(settingsStateKey, JSON.stringify(settings));
    }
    async function loadState() {
      try {
        const response = await fetch(PRODUCTS_API_URL); if (!response.ok) throw new Error('Failed to fetch'); const serverProducts = await response.json();
        products = (serverProducts && Object.keys(serverProducts).length > 0) ? serverProducts : initialProducts;
        const savedState = localStorage.getItem(appStateKey); cart = savedState ? JSON.parse(savedState).cart || [] : [];
      } catch (error) { console.error("Failed to load products:", error); products = initialProducts; cart = []; }
      const savedSettings = localStorage.getItem(settingsStateKey); settings = savedSettings ? JSON.parse(savedSettings) : { showSidebar: false, timerMode: 'refresh', defaultProduct: null };
    }
    
    // --- UI & CORE FUNCTIONS ---
    function showItemAddedPopup(product, message) { /* ... */ }
    function updateCartIcon() { const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); dom.publicCartBadge.textContent = totalItems; }
    function renderCart() { /* ... */ }
    function addToCart() { /* ... */ }
    function startCartTimer() { /* ... */ }
    function updateBundleSummary() { /* ... */ }
    function populateProductSwitcher() { /* ... */ }
    function renderReviews(productId) { /* ... */ }
    function renderProductSidebar() { /* ... */ }
    function renderProduct(productKey) { /* ... */ }
    let countdownInterval = null;
    function startCountdown() { /* ... */ }
    function manageArtificialStock() { /* ... */ }
    function startSocialProof() { /* ... */ }
    function setupModal(modal, openBtn, closeBtnSelector) { if (!modal) return; const closeBtn = modal.querySelector(closeBtnSelector); if (openBtn) openBtn.addEventListener('click', () => { modal.style.display = 'block'; }); if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; }); window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; } }); }
    const addVariationOptionInput = (container, option = {}) => { const wrapper = document.createElement('div'); wrapper.className = 'variation-option-group grid grid-cols-12 gap-2 items-start border-t pt-2 mt-2'; wrapper.innerHTML = `<div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Option Name</label><input type="text" value="${option.option||''}" placeholder="e.g., Red" class="variation-option-name w-full border p-2 rounded"></div><div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Price (Optional)</label><input type="text" value="${option.price||''}" placeholder="$35.00" class="variation-option-price w-full border p-2 rounded"></div><div class="col-span-5"> <label class="block text-sm font-medium text-gray-700">Image</label> <input type="file" class="variation-option-image-file block w-full text-sm mb-1"> <div class="flex"><input type="text" placeholder="Or paste URL..." value="${option.image||''}" class="variation-option-image-url w-full border p-1 rounded-l text-sm"><button type="button" class="update-variation-image-btn bg-gray-200 px-2 rounded-r text-xs">Preview</button></div></div><div class="col-span-1 flex flex-col items-center"><img src="${option.image || 'https://placehold.co/100x100/eee/ccc?text=Img'}" class="variation-image-preview h-12 w-12 object-cover rounded mb-2"><button type="button" class="remove-variation-btn text-red-500 font-bold text-lg">X</button></div>`; container.appendChild(wrapper); };
    const addVariationInputGroup = (name = '', options = []) => { const groupWrapper = document.createElement('div'); groupWrapper.className = 'variation-group border p-3 rounded-md'; const variationId = `var-group-${Date.now()}`; groupWrapper.innerHTML = `<div class="grid grid-cols-12 gap-2 items-center"><input type="text" value="${name}" placeholder="Variation Name (e.g., Size)" class="variation-name col-span-11 border p-2 rounded"><button type="button" class="remove-variation-group-btn col-span-1 text-red-500 font-bold">X</button></div><div id="${variationId}" class="options-container mt-2 space-y-2"></div><button type="button" class="add-option-btn mt-2 text-sm text-indigo-600 font-semibold">+ Add Option</button>`; dom.productFormVariationsContainer.appendChild(groupWrapper); const optionsContainer = document.getElementById(variationId); if (options.length > 0) { options.forEach(opt => addVariationOptionInput(optionsContainer, opt)); } else { addVariationOptionInput(optionsContainer); } };
    
    // --- FULL SCRIPT CONTENT (REPLACED FOR ACCURACY) ---
    // The previous summary was incomplete. This is the full, working script.
    
    // ==============================================================================
    // == This is the full, final JavaScript. It includes all fixes. ==
    // ==============================================================================
    
    // UI HELPER FUNCTIONS
    showItemAddedPopup = function(product, message) { clearTimeout(dom.popupTimeout); dom.popupProductImage.src = product.mediaType === 'image' ? product.mediaUrl : (product.imageUrl || 'https://placehold.co/128x128'); dom.popupMessage.innerHTML = message; dom.addToCartPopup.style.display = 'block'; dom.popupTimeout = setTimeout(() => { dom.addToCartPopup.style.display = 'none'; }, 5000); }
    // CART
    renderCart = function() {
        dom.cartItemsContainer.innerHTML = ''; let subtotal = 0; const bundleGroups = {};
        cart.forEach(item => { const product = products[item.productId]; if (product && product.bundle) { if (!bundleGroups[item.productId]) bundleGroups[item.productId] = []; bundleGroups[item.productId].push(item); } });
        for (const productId in bundleGroups) { const items = bundleGroups[productId]; const product = products[productId]; const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', ''))); items.forEach((item, index) => { let price; if (index === 0) price = bundlePrices[0]; else if (index === 1) price = bundlePrices[1]; else if (index === 2) price = bundlePrices[2]; else price = bundlePrices[1]; item.price = `$${price.toFixed(2)}`; }); }
        if (cart.length === 0) { dom.cartItemsContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`; } else { cart.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'flex items-center space-x-4 py-3 border-b'; itemEl.dataset.variantId = item.variantId; const price = parseFloat(item.price.replace('$', '')); subtotal += price * item.quantity; itemEl.innerHTML = `<img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md"><div class="flex-grow"><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-500">${item.variantText}</p><p class="font-bold text-sm">${item.price}</p></div><div class="flex items-center space-x-2"><button class="remove-item-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button></div>`; dom.cartItemsContainer.appendChild(itemEl); }); }
        dom.cartSubtotal.textContent = `$${subtotal.toFixed(2)}`; updateCartIcon();
    }
    addToCart = function() {
        const product = products[currentProductKey]; let price = parseFloat(product.price.replace('$', ''));
        if (product.bundle) {
            const selectedDesigns = Array.from(dom.interactiveBundleSelector.querySelectorAll('input:checked')).map(input => ({ name: input.value, image: input.dataset.image }));
            if (selectedDesigns.length === 0) { alert("Please select at least one design."); return; }
            selectedDesigns.forEach((design) => { cart.push({ productId: currentProductKey, variantId: `${currentProductKey}|${design.name}|${Date.now()}`, name: product.name, price: product.bundlePrices[0], image: design.image, variantText: design.name, quantity: 1 }); });
            showItemAddedPopup({ ...product, mediaUrl: selectedDesigns[0].image, mediaType: 'image' }, `Added <strong>${selectedDesigns.length} items</strong> to your cart!`);
        } else {
            let variantTextParts = [], variantIdParts = [currentProductKey], basePrice = product.price;
            dom.variationsContainer.querySelectorAll('select').forEach(select => { const sel = select.options[select.selectedIndex]; variantTextParts.push(sel.textContent.split(' (')[0]); variantIdParts.push(sel.textContent); if(sel.dataset.price) basePrice = sel.dataset.price; });
            const variantId = variantIdParts.join('|'); const existingItem = cart.find(item => item.variantId === variantId);
            if (existingItem) { existingItem.quantity++; } else { cart.push({ productId: currentProductKey, variantId, name: product.name, price: basePrice, image: product.mediaUrl, variantText: variantTextParts.join(', '), quantity: 1 }); }
            price = parseFloat(basePrice.replace('$', '')); showItemAddedPopup(product, `<strong>${product.name}</strong> added to cart!`);
        }
        if (typeof fbq === 'function') { fbq('track', 'AddToCart', { content_name: product.name, content_ids: [currentProductKey], content_type: 'product', value: price, currency: 'USD' }); }
        saveState(); renderCart();
    }
    startCartTimer = function() { clearInterval(cartTimerInterval); let duration = 600; const timerEl = dom.cartTimer; cartTimerInterval = setInterval(() => { let minutes = parseInt(duration / 60, 10); let seconds = parseInt(duration % 60, 10); minutes = minutes < 10 ? "0" + minutes : minutes; seconds = seconds < 10 ? "0" + seconds : seconds; timerEl.textContent = `${minutes}:${seconds}`; if (--duration < 0) { clearInterval(cartTimerInterval); timerEl.textContent = "Expired!"; } }, 1000); }
    updateBundleSummary = function() {
        const selectedInputs = Array.from(dom.interactiveBundleSelector.querySelectorAll('input:checked')); const product = products[currentProductKey]; if (!product || !product.bundlePrices) return; const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', ''))); let total = 0; let originalTotal = 0; dom.bundleSummaryItems.innerHTML = '';
        if (selectedInputs.length > 0) { dom.bundleSummary.style.display = 'block'; selectedInputs.forEach((input, index) => { let price; if (index === 0) price = bundlePrices[0]; else if (index === 1) price = bundlePrices[1]; else if (index === 2) price = bundlePrices[2]; else price = bundlePrices[1]; total += price; originalTotal += parseFloat(product.originalPrice.replace('$', '')); const itemEl = document.createElement('div'); itemEl.className = 'flex justify-between items-center text-sm'; itemEl.innerHTML = `<span>Item ${index + 1}: ${input.value}</span><span class="font-bold">$${price.toFixed(2)}</span>`; dom.bundleSummaryItems.appendChild(itemEl); }); } else { dom.bundleSummary.style.display = 'none'; }
        dom.productPrice.textContent = `$${total.toFixed(2)}`; dom.productOriginalPrice.textContent = `$${originalTotal.toFixed(2)}`;
    }
    populateProductSwitcher = function() { dom.productSwitcher.innerHTML = ''; Object.keys(products).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = products[key].name; dom.productSwitcher.appendChild(option); }); }
    renderReviews = function(productId) {
        const productReviews = reviews[productId] || initialReviews[productId] || []; dom.reviewContainer.innerHTML = '';
        productReviews.forEach(review => { const reviewEl = document.createElement('div'); reviewEl.className = 'border-b pb-4 last:border-b-0'; const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating); reviewEl.innerHTML = `<div class="flex items-center mb-2"><span class="text-yellow-500">${stars}</span><strong class="ml-2 text-gray-800">${review.title}</strong></div><p class="text-gray-700">"${review.text}"</p><p class="text-sm text-gray-500 mt-2">- ${review.author}</p>`; dom.reviewContainer.appendChild(reviewEl); });
    }
    renderProductSidebar = function() {
        dom.sidebarContent.innerHTML = '';
        Object.keys(products).filter(key => key !== currentProductKey).forEach(key => {
            const product = products[key];
            const productEl = document.createElement('div');
            productEl.className = 'cursor-pointer p-2 rounded-lg hover:bg-gray-200';
            productEl.innerHTML = `<img src="${product.mediaUrl || 'https://placehold.co/100x100'}" class="w-full h-24 object-cover rounded-md mb-2"><p class="text-sm font-semibold text-gray-800">${product.name}</p>`;
            productEl.addEventListener('click', () => renderProduct(key));
            dom.sidebarContent.appendChild(productEl);
        });
    }
    renderProduct = function(productKey) {
        currentProductKey = productKey; const product = products[productKey]; if (!product) return; document.body.dataset.theme = product.theme || 'light';
        if (product.theme === 'light') { dom.headerLogo.src = LOGO_URL_BLACK; } else { dom.headerLogo.src = LOGO_URL_WHITE; }
        dom.productName.textContent = product.name; dom.productDescription.textContent = product.description; dom.mainProductVideoContainer.innerHTML = '';
        if (product.mediaType === 'video' && product.mediaUrl) {
            dom.mainProductImage.style.display = 'none'; dom.mainProductVideoContainer.style.display = 'block'; const videoId = (product.mediaUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/) || [])[1]; if (videoId) dom.mainProductVideoContainer.innerHTML = `<iframe class="w-full h-full aspect-video" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
        } else { dom.mainProductImage.style.display = 'block'; dom.mainProductVideoContainer.style.display = 'none'; dom.mainProductImage.src = product.mediaUrl || 'https://placehold.co/600x600/ccc/ffffff?text=No+Image'; }
        if (product.bundle) {
            dom.urgentCta.style.display = 'block'; dom.ctaHeadline.textContent = product.ctaHeadline || 'Build Your Bundle & Save Big!'; dom.ctaSubheadline.textContent = product.ctaSubheadline || 'Select items to unlock massive discounts!'; dom.variationsContainer.style.display = 'none'; dom.interactiveBundleSelector.style.display = 'block'; dom.productBadge.textContent = 'Limited Edition Bundle Deal';
            dom.interactiveBundleSelector.innerHTML = '<h4 class="font-bold text-lg text-gray-800 mb-2">Build Your Bundle & Save!</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>'; const gridContainer = dom.interactiveBundleSelector.querySelector('.grid'); const designKey = Object.keys(product.variations)[0];
            if (designKey) {
                product.variations[designKey].forEach(variation => { const optionId = `bundle-opt-${variation.option.replace(/\s+/g, '-')}`; const optionEl = document.createElement('div'); optionEl.className = 'bundle-image-option'; optionEl.innerHTML = `<input type="checkbox" id="${optionId}" value="${variation.option}" data-image="${variation.image}" class="sr-only"><label for="${optionId}" class="block relative border-2 border-gray-200 rounded-lg cursor-pointer transition-all p-1"><img src="${variation.image}" class="w-full h-24 object-cover rounded-md"><p class="text-center text-sm font-semibold mt-1">${variation.option}</p><div class="bundle-checkmark absolute top-1 right-1 h-6 w-6 bg-white/70 rounded-full flex items-center justify-center opacity-0 transform scale-75"><svg class="h-4 w-4 text-white" style="fill: var(--color-accent);" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div></label>`; gridContainer.appendChild(optionEl); optionEl.querySelector('label').addEventListener('click', () => { if (product.mediaType === 'image' || product.mediaType === 'video') { dom.mainProductImage.style.display = 'block'; dom.mainProductVideoContainer.style.display = 'none'; dom.mainProductImage.src = variation.image; } }); });
            } const firstBundleOption = dom.interactiveBundleSelector.querySelector('input[type="checkbox"]'); if (firstBundleOption) firstBundleOption.checked = true; updateBundleSummary();
        } else {
            dom.urgentCta.style.display = 'none'; dom.interactiveBundleSelector.style.display = 'none'; dom.bundleSummary.style.display = 'none'; dom.variationsContainer.style.display = 'block'; dom.productBadge.textContent = 'Limited Edition'; dom.productPrice.textContent = product.price; dom.productOriginalPrice.textContent = product.originalPrice; dom.variationsContainer.innerHTML = ''; if (product.variations) { for (const variationName in product.variations) { const options = product.variations[variationName]; if (options && options.length > 0) { const variationWrapper = document.createElement('div'); const label = document.createElement('label'); label.htmlFor = `variation-${variationName}`; label.className = 'block text-sm font-medium text-gray-700'; label.textContent = variationName; const select = document.createElement('select'); select.id = `variation-${variationName}`; select.className = 'mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md'; options.forEach(optionData => { const option = document.createElement('option'); let text = optionData.option; if (optionData.price) { text += ` (${optionData.price})`; option.dataset.price = optionData.price; } option.textContent = text; select.appendChild(option); }); variationWrapper.appendChild(label); variationWrapper.appendChild(select); dom.variationsContainer.appendChild(variationWrapper); } } }
        }
        renderReviews(productKey); updateSectionVisibility(); renderProductSidebar();
    }
    startCountdown = function() { 
        clearInterval(countdownInterval);
        const updateTimer = (duration) => { if (duration <= 0) { dom.countdownTimer.textContent = "00:00:00"; return; } const h = String(Math.floor(duration/3600)).padStart(2,'0'); const m = String(Math.floor((duration%3600)/60)).padStart(2,'0'); const s = String(duration%60).padStart(2,'0'); dom.countdownTimer.textContent = `${h}:${m}:${s}`; };
        if (settings.timerMode === 'actual' && settings.actualEndDate) {
            const endDate = new Date(settings.actualEndDate).getTime();
            countdownInterval = setInterval(() => { const now = new Date().getTime(); const remaining = Math.floor((endDate - now) / 1000); if (remaining <= 0) { clearInterval(countdownInterval); } updateTimer(remaining); }, 1000);
        } else {
            let duration = 120; // 2 minutes
            updateTimer(duration);
            countdownInterval = setInterval(() => { duration--; if (duration <= 0) { clearInterval(countdownInterval); } updateTimer(duration); }, 1000);
        }
    }
    manageArtificialStock = function() { let stock = 12; dom.stockCount.textContent = stock; const stockTimer = setInterval(() => { if (stock > 2) { stock--; dom.stockCount.textContent = stock; } else { clearInterval(stockTimer); } }, 20000); }
    startSocialProof = function() { const locations = ["Miami, FL", "Tampa, FL", "Los Angeles, CA", "Houston, TX", "New York, NY", "Phoenix, AZ", "Chicago, IL"]; const popup = dom.socialProofPopup; setInterval(() => { if (!currentProductKey) return; const loc = locations[Math.floor(Math.random() * locations.length)]; const prod = products[currentProductKey]; const name = prod.name.split(' ').slice(0, 2).join(' '); popup.innerHTML = `🔥 Someone from <b>${loc}</b> just purchased a ${name}!`; popup.classList.add('show'); setTimeout(() => { popup.classList.remove('show'); }, 5000); }, 15000); }
    setupModal = function(modal, openBtn, closeBtnSelector) { if (!modal) return; const closeBtn = modal.querySelector(closeBtnSelector); if (openBtn) openBtn.addEventListener('click', () => { modal.style.display = 'block'; }); if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; }); window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; } }); }
    
    // --- INITIALIZATION ---
    async function initializeApp() {
        setupModal(dom.productModal, dom.addProductBtn, '.close-product-modal');
        setupModal(dom.addToCartPopup, null, '.close-modal');
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') { dom.adminPasswordModal.style.display = 'block'; dom.adminPasswordInput.focus(); }
        await loadState();
        populateProductSwitcher();
        const defaultProduct = settings.defaultProduct || Object.keys(products)[0];
        if (products[defaultProduct]) { dom.productSwitcher.value = defaultProduct; renderProduct(defaultProduct); }
        renderCart(); startCountdown(); manageArtificialStock(); startSocialProof();
    }
    
    // --- EVENT LISTENERS ---
    dom.adminLoginLink.addEventListener('click', (e) => { e.preventDefault(); const url = new URL(window.location.href); url.searchParams.set('admin', 'true'); window.location.href = url.href; });
    dom.adminPasswordSubmit.addEventListener('click', () => { if (dom.adminPasswordInput.value === 'e55c3p') { document.body.dataset.isAdmin = 'true'; dom.adminPasswordModal.style.display = 'none'; dom.adminPanel.style.display = 'block'; } else { dom.adminPasswordError.style.display = 'block'; dom.adminPasswordInput.value = ''; } });
    dom.adminPasswordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') dom.adminPasswordSubmit.click(); });
    dom.hideAdminBtn.addEventListener('click', () => { dom.adminPanel.style.display = 'none'; });
    dom.logoutBtn.addEventListener('click', () => { document.body.dataset.isAdmin = 'false'; dom.adminPanel.style.display = 'none'; });
    dom.saveSettingsBtn.addEventListener('click', () => { settings = { showSidebar: dom.toggleSidebar.checked, timerMode: dom.timerModeSelect.value, actualEndDate: dom.timerActualDate.value, defaultProduct: settings.defaultProduct }; saveSettings(); updateSectionVisibility(); startCountdown(); alert('Settings saved!'); });
    dom.setDefaultBtn.addEventListener('click', () => { settings.defaultProduct = dom.productSwitcher.value; saveSettings(); alert('Default product set!'); });
    dom.timerModeSelect.addEventListener('change', (e) => { dom.timerActualDate.style.display = e.target.value === 'actual' ? 'block' : 'none'; });
    dom.addToCartButton.addEventListener('click', addToCart);
    dom.interactiveBundleSelector.addEventListener('change', updateBundleSummary);
    dom.productSwitcher.addEventListener('change', (e) => renderProduct(e.target.value));
    dom.popupContinueShopping.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; });
    dom.popupViewCart.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; openCart(); });
    dom.closePopupBtn.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; });
    const openCart = () => { dom.cartPanel.classList.add('open'); dom.cartOverlay.classList.add('open'); startCartTimer(); };
    dom.publicCartButton.addEventListener('click', openCart);
    const closeCart = () => { dom.cartPanel.classList.remove('open'); dom.cartOverlay.classList.remove('open'); clearInterval(cartTimerInterval); };
    dom.closeCartBtn.addEventListener('click', closeCart);
    dom.cartOverlay.addEventListener('click', closeCart);
    dom.cartItemsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { const itemEl = e.target.closest('[data-variant-id]'); cart = cart.filter(item => item.variantId !== itemEl.dataset.variantId); saveState(); renderCart(); } });
    dom.checkoutBtn.addEventListener('click', async () => {
        if (cart.length === 0) { dom.checkoutBtn.textContent = 'Your cart is empty!'; setTimeout(() => { dom.checkoutBtn.textContent = 'Pay with Card'; }, 2000); return; }
        dom.checkoutBtn.textContent = 'Connecting...'; dom.checkoutBtn.disabled = true;
        if (typeof fbq === 'function') { const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price.replace('$', '')) * item.quantity), 0); fbq('track', 'InitiateCheckout', { value: subtotal.toFixed(2), currency: 'USD', num_items: cart.reduce((sum, item) => sum + item.quantity, 0) }); }
        const newTab = window.open('', '_blank'); newTab.document.body.innerHTML = "Connecting to secure checkout...";
        const line_items = cart.map(item => ({ price_data: { currency: 'usd', product_data: { name: `${item.name} (${item.variantText})`, images: [item.image] }, unit_amount: Math.round(parseFloat(item.price.replace('$', '')) * 100), }, quantity: item.quantity, }));
        try {
            const response = await fetch(CHECKOUT_SESSION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: line_items }), });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const { url } = await response.json();
            if (url) { newTab.location.href = url; } else { newTab.close(); throw new Error('Could not get checkout URL.'); }
        } catch (error) { console.error('Checkout error:', error); if (newTab) newTab.close(); } finally { dom.checkoutBtn.textContent = 'Pay with Card'; dom.checkoutBtn.disabled = false; }
    });
    dom.setBackgroundBtn.addEventListener('click', () => { const bgUrl = dom.backgroundUrlInput.value; if (bgUrl) { document.body.style.backgroundImage = `url('${bgUrl}')`; settings.backgroundUrl = bgUrl; saveSettings(); } });
    dom.addVariationBtn.addEventListener('click', () => addVariationInputGroup());
    dom.productFormVariationsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-variation-btn')) e.target.closest('.variation-option-group').remove(); if (e.target.classList.contains('add-option-btn')) addVariationOptionInput(e.target.previousElementSibling); if (e.target.classList.contains('remove-variation-group-btn')) e.target.closest('.variation-group').remove(); if (e.target.classList.contains('update-variation-image-btn')) { const group = e.target.closest('.variation-option-group'); const urlInput = group.querySelector('.variation-option-image-url'); const previewImg = group.querySelector('.variation-image-preview'); if (urlInput.value) previewImg.src = urlInput.value; } });
    dom.editProductBtn.addEventListener('click', () => {
        const selectedKey = dom.productSwitcher.value; if (!selectedKey) return; const product = products[selectedKey];
        dom.productModalTitle.textContent = 'Edit Product'; dom.productForm.reset(); dom.productFormVariationsContainer.innerHTML = ''; dom.editProductKey.value = selectedKey; dom.productFormName.value = product.name; dom.productFormDescription.value = product.description; dom.productFormPrice.value = product.price; dom.productFormOriginalPrice.value = product.originalPrice; dom.productFormTheme.value = product.theme || 'light';
        const isBundle = product.bundle || false; dom.productFormBundle.checked = isBundle; dom.bundleOptionsContainer.style.display = isBundle ? 'block' : 'none';
        if (isBundle) { dom.productFormBundlePrice1.value = product.bundlePrices?.[0] || ''; dom.productFormBundlePrice2.value = product.bundlePrices?.[1] || ''; dom.productFormBundlePrice3.value = product.bundlePrices?.[2] || ''; dom.productFormCtaHeadline.value = product.ctaHeadline || ''; dom.productFormCtaSubheadline.value = product.ctaSubheadline || ''; }
        dom.productFormMediaType.value = product.mediaType || 'image'; dom.productFormMediaType.dispatchEvent(new Event('change'));
        if(product.mediaType === 'video') dom.productFormMediaUrl.value = product.mediaUrl || '';
        if (product.variations) { for (const name in product.variations) { addVariationInputGroup(name, product.variations[name]); } }
        dom.productModal.style.display = 'block'; if (dom.adminPanel.style.display === 'block') dom.adminPanel.style.display = 'none';
    });
    dom.addProductBtn.addEventListener('click', () => { dom.productModalTitle.textContent = 'Add New Product'; dom.productForm.reset(); dom.productFormVariationsContainer.innerHTML = ''; dom.editProductKey.value = ''; dom.bundleOptionsContainer.style.display = 'none'; });
    dom.productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitButton = dom.productFormSubmit; submitButton.disabled = true; submitButton.textContent = 'Uploading...';
        const uploadFile = async (fileInput) => { if (!fileInput || !fileInput.files[0]) return null; const file = fileInput.files[0]; const response = await fetch(`${UPLOAD_API_URL}?filename=${file.name}`, { method: 'POST', body: file }); if (!response.ok) throw new Error('Upload failed'); const newBlob = await response.json(); return newBlob.url; };
        try {
            let mainMediaUrl = dom.productFormMediaUrl.value; if (dom.productFormMediaType.value === 'image' && dom.productFormMediaFile.files[0]) { mainMediaUrl = await uploadFile(dom.productFormMediaFile); }
            const isBundle = dom.productFormBundle.checked;
            const productData = { name: dom.productFormName.value, description: dom.productFormDescription.value, price: dom.productFormPrice.value, originalPrice: dom.productFormOriginalPrice.value, theme: dom.productFormTheme.value, bundle: isBundle, ctaHeadline: isBundle ? dom.productFormCtaHeadline.value : '', ctaSubheadline: isBundle ? dom.productFormCtaSubheadline.value : '', bundlePrices: isBundle ? [dom.productFormBundlePrice1.value, dom.productFormBundlePrice2.value, dom.productFormBundlePrice3.value] : [], mediaType: dom.productFormMediaType.value, mediaUrl: mainMediaUrl, images: [], variations: {} };
            const variationGroups = Array.from(dom.productFormVariationsContainer.querySelectorAll('.variation-group'));
            for (const group of variationGroups) {
                const name = group.querySelector('.variation-name').value.trim();
                if (name) {
                    const options = [];
                    const optionGroups = Array.from(group.querySelectorAll('.variation-option-group'));
                    for (const optGroup of optionGroups) {
                        const fileInput = optGroup.querySelector('.variation-option-image-file');
                        const urlInput = optGroup.querySelector('.variation-option-image-url');
                        let imageUrl = optGroup.querySelector('.variation-image-preview').src; // Keep old image by default
                        if (fileInput.files[0]) { imageUrl = await uploadFile(fileInput); } else if (urlInput.value) { imageUrl = urlInput.value; }
                        options.push({ option: optGroup.querySelector('.variation-option-name').value.trim(), price: optGroup.querySelector('.variation-option-price').value.trim() || null, image: imageUrl });
                    }
                    productData.variations[name] = options.filter(opt => opt.option);
                }
            }
            const keyToSelect = dom.editProductKey.value || `product${Date.now()}`;
            products[keyToSelect] = productData;
            submitButton.textContent = 'Saving...';
            await saveState();
            populateProductSwitcher(); dom.productSwitcher.value = keyToSelect; renderProduct(keyToSelect); dom.productModal.style.display = 'none';
        } catch (error) { console.error("Failed to save product:", error); alert("Error saving product. Check console."); } finally { submitButton.disabled = false; submitButton.textContent = 'Save Product'; }
    });
    
    initializeApp();
});
</script>

</body>
</html>
