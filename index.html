<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- BRANDING CONFIG ---
    const LOGO_URL_WHITE = 'https://i.imgur.com/7B5NkbX.png';
    const LOGO_URL_BLACK = 'https://i.imgur.com/mY9JuRX.png';

    // --- STRIPE & SERVER CONFIG ---
    // ==============================================================================
    // == PASTE YOUR KEYS AND URLS HERE ==
    // ==============================================================================
    
    const STRIPE_PUBLISHABLE_KEY = 'YOUR_PUBLISHABLE_KEY_HERE'; 
    const CHECKOUT_SESSION_URL = 'pk_live_51SIdrnHPi9QM97mFMDciuMPOW7GX2mXliZq769HyO6WKs52bIqwXbRg5nK1IDAIQFK8DYexoiZftmPYtx8WG1H2D001i6OPZZj';
    const PRODUCTS_API_URL = '/api/products'; // Uses a relative path to your new server file
    
    // ==============================================================================
    // ==============================================================================


    // --- STATE MANAGEMENT ---
    let products = {};
    let reviews = {}; // Reviews will still be local/hardcoded for now
    let cart = [];
    let currentProductKey = null;
    const appStateKey = 'urgentLandingPageState_v12'; // Updated version
    let settings = {};
    const settingsStateKey = 'urgentLandingPageSettings';
    let cartTimerInterval = null;

    // This is now a fallback if the database is empty
    const initialProducts = {
        product1: {
            name: 'Your First Product',
            description: 'Edit or delete this product from the admin panel.',
            price: '$19.99',
            originalPrice: '$25.00',
            theme: 'light',
            mediaType: 'image',
            mediaUrl: 'https://placehold.co/600x600/ccc/ffffff?text=My+Product',
            images: [],
            variations: { 'Size': [ { option: 'M' } ]},
            bundle: false
        }
    };
    
    const initialReviews = {
        product1: [ { rating: 5, title: "Works Great!", text: "This is exactly what I needed.", author: "Jane D." } ],
    };

    // NEW ASYNC saveState and loadState
    async function saveState() {
      try {
        await fetch(PRODUCTS_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products: products })
        });
        localStorage.setItem(appStateKey, JSON.stringify({ cart })); // Only save cart locally
      } catch (error) {
        console.error("Failed to save products to database:", error);
      }
    }

    async function loadState() {
      try {
        const response = await fetch(PRODUCTS_API_URL);
        if (!response.ok) throw new Error('Failed to fetch from server');
        const serverProducts = await response.json();
        
        products = (serverProducts && Object.keys(serverProducts).length > 0) ? serverProducts : initialProducts;
        
        const savedState = localStorage.getItem(appStateKey);
        cart = savedState ? JSON.parse(savedState).cart || [] : [];

      } catch (error) {
        console.error("Failed to load products from database, using fallback:", error);
        products = initialProducts;
        cart = [];
      }
      
      const savedSettings = localStorage.getItem(settingsStateKey);
      settings = savedSettings ? JSON.parse(savedSettings) : { showShipping: true, showReviews: true, showPerks: true, showCustomization: false };
    }

    // --- DOM ELEMENTS (No changes here) ---
    // ... (rest of your DOM element variables) ...
    const themeWrapper = document.getElementById('theme-wrapper');
    const mediaContainer = document.getElementById('media-container');
    const mainProductImageEl = document.getElementById('main-product-image');
    const mainProductVideoContainer = document.getElementById('main-product-video-container');
    const thumbnailContainerEl = document.getElementById('thumbnail-container');
    const variationsContainerEl = document.getElementById('variations-container');
    const interactiveBundleSelector = document.getElementById('interactive-bundle-selector');
    const bundleSummary = document.getElementById('bundle-summary');
    const bundleSummaryItems = document.getElementById('bundle-summary-items');
    const shippingSection = document.getElementById('shipping-section');
    const reviewsSection = document.getElementById('reviews-section');
    const perksSection = document.getElementById('perks-section');
    const customizationSection = document.getElementById('customization-section');
    const productSwitcher = document.getElementById('product-switcher');
    const productBadgeEl = document.getElementById('product-badge');
    const productNameEl = document.getElementById('product-name');
    const productDescriptionEl = document.getElementById('product-description');
    const productPriceEl = document.getElementById('product-price');
    const productOriginalPriceEl = document.getElementById('product-original-price');
    const reviewContainer = document.getElementById('review-container');
    const countdownElement = document.getElementById('countdown-timer');
    const stockCountElement = document.getElementById('stock-count');
    const adminPanel = document.getElementById('admin-panel');
    const pageContainer = document.getElementById('page-container');
    const headerLogo = document.getElementById('header-logo');
    const footerLogoWhite = document.getElementById('footer-logo-white');
    const adminPasswordModal = document.getElementById('admin-password-modal');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminPasswordSubmit = document.getElementById('admin-password-submit');
    const adminPasswordError = document.getElementById('admin-password-error');
    const adminLoginLink = document.getElementById('admin-login-link');
    const hideAdminBtn = document.getElementById('hide-admin-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const toggleShipping = document.getElementById('toggle-shipping');
    const toggleReviews = document.getElementById('toggle-reviews');
    const togglePerks = document.getElementById('toggle-perks');
    const toggleCustomization = document.getElementById('toggle-customization');
    const productDetailsContainer = document.getElementById('product-details-container');
    const urgentCta = document.getElementById('urgent-cta');
    const ctaHeadlineEl = document.getElementById('cta-headline');
    const ctaSubheadlineEl = document.getElementById('cta-subheadline');
    const setBackgroundBtn = document.getElementById('set-background-btn');
    const backgroundUrlInput = document.getElementById('background-url-input');
    const adminMediaType = document.getElementById('admin-media-type');
    const adminMediaUrl = document.getElementById('admin-media-url');
    const saveMediaBtn = document.getElementById('save-media-btn');
    const cartPanel = document.getElementById('cart-panel');
    const cartOverlay = document.getElementById('cart-overlay');
    const publicCartButton = document.getElementById('public-cart-button');
    const publicCartBadge = document.getElementById('public-cart-badge');
    const closeCartBtn = document.getElementById('close-cart-btn');
    const cartItemsContainer = document.getElementById('cart-items-container');
    const cartSubtotalEl = document.getElementById('cart-subtotal');
    const checkoutBtn = document.getElementById('checkout-btn');
    const addToCartPopup = document.getElementById('add-to-cart-popup');
    const popupProductImage = document.getElementById('popup-product-image');
    const popupMessage = document.getElementById('popup-message');
    const popupContinueShopping = document.getElementById('popup-continue-shopping');
    const popupViewCart = document.getElementById('popup-view-cart');
    const closePopupBtn = document.getElementById('close-popup-btn');
    let popupTimeout = null;
    

    // --- Rest of your JavaScript functions (no changes needed) ---
    // ... (showItemAddedPopup, updateCartIcon, renderCart, addToCart, startCartTimer, etc.) ...
    // ... (All of the functions you had before, unchanged) ...
    
    // UI HELPER
    function showItemAddedPopup(product, message) { clearTimeout(popupTimeout); popupProductImage.src = product.mediaType === 'image' ? product.mediaUrl : (product.images && product.images[0] ? product.images[0] : 'https://placehold.co/128x128'); popupMessage.innerHTML = message; addToCartPopup.style.display = 'block'; popupTimeout = setTimeout(() => { addToCartPopup.style.display = 'none'; }, 5000); }
    // CART
    function updateCartIcon() { const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); publicCartBadge.textContent = totalItems; }
    function renderCart() {
        cartItemsContainer.innerHTML = '';
        let subtotal = 0;
        const bundleGroups = {};
        cart.forEach(item => { const product = products[item.productId]; if (product && product.bundle) { if (!bundleGroups[item.productId]) bundleGroups[item.productId] = []; bundleGroups[item.productId].push(item); } });
        for (const productId in bundleGroups) {
            const items = bundleGroups[productId];
            const product = products[productId];
            const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', '')));
            items.forEach((item, index) => { let price; if (index === 0) price = bundlePrices[0]; else if (index === 1) price = bundlePrices[1]; else if (index === 2) price = bundlePrices[2]; else price = bundlePrices[1]; item.price = `$${price.toFixed(2)}`; });
        }
        if (cart.length === 0) { cartItemsContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`; } else {
            cart.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center space-x-4 py-3 border-b';
                itemEl.dataset.variantId = item.variantId;
                const price = parseFloat(item.price.replace('$', ''));
                subtotal += price * item.quantity;
                itemEl.innerHTML = `<img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md"><div class="flex-grow"><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-500">${item.variantText}</p><p class="font-bold text-sm">${item.price}</p></div><div class="flex items-center space-x-2"><input type="number" min="1" value="${item.quantity}" class="quantity-input w-12 text-center border rounded"><button class="remove-item-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button></div>`;
                cartItemsContainer.appendChild(itemEl);
            });
        }
        cartSubtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        updateCartIcon();
    }
    function addToCart() {
        const product = products[currentProductKey];
        let price = parseFloat(product.price.replace('$', ''));
        if (product.bundle) {
            const selectedDesigns = Array.from(interactiveBundleSelector.querySelectorAll('input:checked')).map(input => ({ name: input.value, image: input.dataset.image }));
            if (selectedDesigns.length === 0) { alert("Please select at least one design to add to your bundle."); return; }
            selectedDesigns.forEach((design) => { cart.push({ productId: currentProductKey, variantId: `${currentProductKey}|${design.name}|${Date.now()}`, name: product.name, price: product.bundlePrices[0], image: design.image, variantText: design.name, quantity: 1 }); });
            const popupProductInfo = { ...product, mediaUrl: selectedDesigns[0].image, mediaType: 'image' };
            showItemAddedPopup(popupProductInfo, `Added <strong>${selectedDesigns.length} masks</strong> to your cart!`);
        } else {
            const variationSelects = variationsContainerEl.querySelectorAll('select');
            let variantTextParts = [];
            let variantIdParts = [currentProductKey];
            let basePrice = product.price;
            variationSelects.forEach(select => { const selectedOption = select.options[select.selectedIndex]; variantTextParts.push(selectedOption.textContent.split(' (')[0]); variantIdParts.push(selectedOption.textContent); if (selectedOption.dataset.price) basePrice = selectedOption.dataset.price; });
            const variantId = variantIdParts.join('|');
            const existingItem = cart.find(item => item.variantId === variantId);
            if (existingItem) { existingItem.quantity++; } else { cart.push({ productId: currentProductKey, variantId: variantId, name: product.name, price: basePrice, image: product.mediaUrl, variantText: variantTextParts.join(', '), quantity: 1 }); }
            price = parseFloat(basePrice.replace('$', ''));
            showItemAddedPopup(product, `<strong>${product.name}</strong> added to cart!`);
        }
        if (typeof fbq === 'function') { fbq('track', 'AddToCart', { content_name: product.name, content_ids: [currentProductKey], content_type: 'product', value: price, currency: 'USD' }); }
        saveState();
        renderCart();
    }
    function startCartTimer() { clearInterval(cartTimerInterval); let duration = 600; const timerEl = document.getElementById('cart-timer'); cartTimerInterval = setInterval(() => { let minutes = parseInt(duration / 60, 10); let seconds = parseInt(duration % 60, 10); minutes = minutes < 10 ? "0" + minutes : minutes; seconds = seconds < 10 ? "0" + seconds : seconds; timerEl.textContent = `${minutes}:${seconds}`; if (--duration < 0) { clearInterval(cartTimerInterval); timerEl.textContent = "Expired!"; } }, 1000); }
    function updateBundleSummary() {
        const selectedInputs = Array.from(interactiveBundleSelector.querySelectorAll('input:checked'));
        const product = products[currentProductKey];
        if (!product || !product.bundlePrices) return;
        const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', '')));
        let total = 0;
        let originalTotal = 0;
        bundleSummaryItems.innerHTML = '';
        if (selectedInputs.length > 0) {
            bundleSummary.style.display = 'block';
            selectedInputs.forEach((input, index) => {
                let price;
                if (index === 0) price = bundlePrices[0]; else if (index === 1) price = bundlePrices[1]; else if (index === 2) price = bundlePrices[2]; else price = bundlePrices[1];
                total += price;
                originalTotal += parseFloat(product.originalPrice.replace('$', ''));
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-center text-sm';
                itemEl.innerHTML = `<span>Item ${index + 1}: ${input.value}</span><span class="font-bold">$${price.toFixed(2)}</span>`;
                bundleSummaryItems.appendChild(itemEl);
            });
        } else { bundleSummary.style.display = 'none'; }
        productPriceEl.textContent = `$${total.toFixed(2)}`;
        productOriginalPriceEl.textContent = `$${originalTotal.toFixed(2)}`;
    }
    // RENDER
    function populateProductSwitcher() { productSwitcher.innerHTML = ''; Object.keys(products).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = products[key].name; productSwitcher.appendChild(option); }); }
    function renderReviews(productId) {
        const productReviews = reviews[productId] || initialReviews[productId] || [];
        reviewContainer.innerHTML = '';
        productReviews.forEach(review => {
            const reviewElement = document.createElement('div');
            reviewElement.className = 'border-b pb-4 last:border-b-0';
            const ratingStars = 'â˜…'.repeat(review.rating) + 'â˜†'.repeat(5 - review.rating);
            reviewElement.innerHTML = `<div class="flex items-center mb-2"><span class="text-yellow-500">${ratingStars}</span><strong class="ml-2 text-gray-800">${review.title}</strong></div><p class="text-gray-700">"${review.text}"</p><p class="text-sm text-gray-500 mt-2">- ${review.author}</p>`;
            reviewContainer.appendChild(reviewElement);
        });
    }
    function renderProduct(productKey) {
        currentProductKey = productKey;
        const product = products[productKey];
        if (!product) return;
        document.body.dataset.theme = product.theme || 'light';
        adminMediaType.value = product.mediaType || 'image';
        adminMediaUrl.value = product.mediaUrl || '';
        if (product.theme === 'light') { headerLogo.src = LOGO_URL_BLACK; } else { headerLogo.src = LOGO_URL_WHITE; }
        productNameEl.textContent = product.name;
        productDescriptionEl.textContent = product.description;
        mainProductVideoContainer.innerHTML = '';
        if (product.mediaType === 'video' && product.mediaUrl) {
            mainProductImageEl.style.display = 'none';
            mainProductVideoContainer.style.display = 'block';
            const videoIdMatch = product.mediaUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            const videoId = videoIdMatch ? videoIdMatch[1] : null;
            if (videoId) mainProductVideoContainer.innerHTML = `<iframe class="w-full h-full aspect-video" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
        } else {
            mainProductImageEl.style.display = 'block';
            mainProductVideoContainer.style.display = 'none';
            mainProductImageEl.src = product.mediaUrl || 'https://placehold.co/600x600/ccc/ffffff?text=No+Image';
        }
        thumbnailContainerEl.innerHTML = '';
        if (product.images && product.images.length > 0) {
            product.images.forEach(imgSrc => {
                if (!imgSrc) return;
                const thumb = document.createElement('img');
                thumb.src = imgSrc;
                thumb.className = 'cursor-pointer h-20 w-full object-cover rounded-md border-2 border-transparent hover:border-indigo-400 transition-all';
                thumb.addEventListener('click', () => { mainProductVideoContainer.style.display = 'none'; mainProductImageEl.style.display = 'block'; mainProductImageEl.src = imgSrc; thumbnailContainerEl.querySelectorAll('img').forEach(t => t.classList.remove('thumbnail-active')); thumb.classList.add('thumbnail-active'); });
                thumbnailContainerEl.appendChild(thumb);
            });
        }
        if (product.bundle) {
            urgentCta.style.display = 'block';
            ctaHeadlineEl.textContent = product.ctaHeadline || 'Build Your Bundle & Save Big!';
            ctaSubheadlineEl.textContent = product.ctaSubheadline || 'Select items to unlock massive discounts!';
            variationsContainerEl.style.display = 'none';
            interactiveBundleSelector.style.display = 'block';
            productBadgeEl.textContent = 'Limited Edition Bundle Deal';
            interactiveBundleSelector.innerHTML = '<h4 class="font-bold text-lg text-gray-800 mb-2">Build Your Bundle & Save!</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>';
            const gridContainer = interactiveBundleSelector.querySelector('.grid');
            const designKey = Object.keys(product.variations)[0];
            if (designKey) {
                product.variations[designKey].forEach(variation => {
                    const optionId = `bundle-opt-${variation.option.replace(/\s+/g, '-')}`;
                    const optionEl = document.createElement('div');
                    optionEl.className = 'bundle-image-option';
                    optionEl.innerHTML = `<input type="checkbox" id="${optionId}" value="${variation.option}" data-image="${variation.image}" class="sr-only"><label for="${optionId}" class="block relative border-2 border-gray-200 rounded-lg cursor-pointer transition-all duration-200 p-1"><img src="${variation.image}" class="w-full h-24 object-cover rounded-md"><p class="text-center text-sm font-semibold mt-1">${variation.option}</p><div class="bundle-checkmark absolute top-1 right-1 h-6 w-6 bg-white/70 border-2 border-white rounded-full flex items-center justify-center transition-all duration-200 opacity-0 transform scale-75"><svg class="h-4 w-4 text-white" style="fill: var(--color-accent);" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" fill-rule="evenodd"></path></svg></div></label>`;
                    gridContainer.appendChild(optionEl);
                    optionEl.querySelector('label').addEventListener('click', () => { if (product.mediaType === 'image' || product.mediaType === 'video') { mainProductImageEl.style.display = 'block'; mainProductVideoContainer.style.display = 'none'; mainProductImageEl.src = variation.image; } });
                });
            }
            const firstBundleOption = interactiveBundleSelector.querySelector('input[type="checkbox"]');
            if (firstBundleOption) firstBundleOption.checked = true;
            updateBundleSummary();
        } else {
            urgentCta.style.display = 'none';
            interactiveBundleSelector.style.display = 'none';
            bundleSummary.style.display = 'none';
            variationsContainerEl.style.display = 'block';
            productBadgeEl.textContent = 'Limited Edition';
            productPriceEl.textContent = product.price;
            productOriginalPriceEl.textContent = product.originalPrice;
            variationsContainerEl.innerHTML = '';
            if (product.variations) {
                for (const variationName in product.variations) {
                    const options = product.variations[variationName];
                    if (options && options.length > 0) {
                        const variationWrapper = document.createElement('div');
                        const label = document.createElement('label');
                        label.htmlFor = `variation-${variationName}`;
                        label.className = 'block text-sm font-medium text-gray-700';
                        label.textContent = variationName;
                        const select = document.createElement('select');
                        select.id = `variation-${variationName}`;
                        select.className = 'mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md';
                        options.forEach(optionData => { const option = document.createElement('option'); let text = optionData.option; if (optionData.price) { text += ` (${optionData.price})`; option.dataset.price = optionData.price; } option.textContent = text; select.appendChild(option); });
                        variationWrapper.appendChild(label);
                        variationWrapper.appendChild(select);
                        variationsContainerEl.appendChild(variationWrapper);
                    }
                }
            }
        }
        renderReviews(productKey);
        updateSectionVisibility();
    }
    // URGENCY
    function startCountdown() { let duration = 8100; const timer = setInterval(() => { if (duration <= 0) { clearInterval(timer); countdownElement.textContent = "00:00:00"; return; } duration--; const hours = String(Math.floor(duration / 3600)).padStart(2, '0'); const minutes = String(Math.floor((duration % 3600) / 60)).padStart(2, '0'); const seconds = String(duration % 60).padStart(2, '0'); countdownElement.textContent = `${hours}:${minutes}:${seconds}`; }, 1000); }
    function manageArtificialStock() { let stock = 12; stockCountElement.textContent = stock; const stockTimer = setInterval(() => { if (stock > 2) { stock--; stockCountElement.textContent = stock; } else { clearInterval(stockTimer); } }, 20000); }
    function startSocialProof() { const locations = ["Miami, FL", "Tampa, FL", "Orlando, FL", "Jacksonville, FL", "Los Angeles, CA", "San Diego, CA", "San Francisco, CA", "Sacramento, CA", "Long Beach, CA", "Houston, TX", "Dallas, TX", "Austin, TX", "San Antonio, TX", "Fort Worth, TX", "New York, NY", "Brooklyn, NY", "Buffalo, NY", "Rochester, NY", "Phoenix, AZ", "Tucson, AZ", "Scottsdale, AZ", "Mesa, AZ", "Chicago, IL", "Naperville, IL", "Aurora, IL", "Atlanta, GA", "Denver, CO", "Seattle, WA", "Boston, MA", "Las Vegas, NV", "Philadelphia, PA"]; const popup = document.getElementById('social-proof-popup'); setInterval(() => { if (!currentProductKey) return; const randomLocation = locations[Math.floor(Math.random() * locations.length)]; const product = products[currentProductKey]; const productName = product.name.split(' ').slice(0, 2).join(' '); popup.innerHTML = `ðŸ”¥ Someone from <b>${randomLocation}</b> just purchased a ${productName}!`; popup.classList.add('show'); setTimeout(() => { popup.classList.remove('show'); }, 5000); }, 15000); }
    // MODAL
    const productModal = document.getElementById('product-modal');
    const productForm = document.getElementById('product-form');
    function setupModal(modal, openBtn, closeBtnSelector) { const closeBtn = modal.querySelector(closeBtnSelector); if (openBtn) openBtn.addEventListener('click', () => { modal.style.display = 'block'; if (adminPanel.style.display === 'block') adminPanel.style.display = 'none'; }); if (closeBtn) closeBtn.addEventListener('click', () => { modal.style.display = 'none'; if (document.body.dataset.isAdmin === 'true') adminPanel.style.display = 'block'; }); window.addEventListener('click', (event) => { if (event.target == modal) { modal.style.display = 'none'; if (document.body.dataset.isAdmin === 'true') adminPanel.style.display = 'block'; } }); }
    setupModal(productModal, document.getElementById('add-product-btn'), '.close-product-modal');
    // PRODUCT MGMT
    const productFormVariationsContainer = document.getElementById('product-form-variations-container');
    const addVariationOptionInput = (container, option = {}) => { const wrapper = document.createElement('div'); wrapper.className = 'variation-option-group grid grid-cols-12 gap-2 items-center'; wrapper.innerHTML = `<div class="col-span-1"></div><input type="text" value="${option.option || ''}" placeholder="Option Name (e.g., Red)" class="variation-option-name col-span-3 border p-2 rounded"><input type="text" value="${option.price || ''}" placeholder="Price (optional)" class="variation-option-price col-span-4 border p-2 rounded"><input type="text" value="${option.image || ''}" placeholder="Image URL (optional)" class="variation-option-image col-span-3 border p-2 rounded"><button type="button" class="remove-variation-btn col-span-1 text-red-500 font-bold text-lg hover:text-red-700">X</button>`; container.appendChild(wrapper); };
    const addVariationInputGroup = (name = '', options = []) => { const groupWrapper = document.createElement('div'); groupWrapper.className = 'variation-group border p-3 rounded-md'; const variationId = `var-group-${Date.now()}`; groupWrapper.innerHTML = `<div class="grid grid-cols-12 gap-2 items-center"><input type="text" value="${name}" placeholder="Variation Name (e.g., Size)" class="variation-name col-span-11 border p-2 rounded"><button type="button" class="remove-variation-group-btn col-span-1 text-red-500 font-bold text-lg hover:text-red-700">X</button></div><div id="${variationId}" class="options-container mt-2 space-y-2"></div><button type="button" class="add-option-btn mt-2 text-xs text-indigo-600 hover:text-indigo-800 font-semibold">+ Add Option</button>`; productFormVariationsContainer.appendChild(groupWrapper); const optionsContainer = document.getElementById(variationId); if (options && options.length > 0) { options.forEach(opt => addVariationOptionInput(optionsContainer, opt)); } else { addVariationOptionInput(optionsContainer); } };
    document.getElementById('add-variation-btn').addEventListener('click', () => addVariationInputGroup());
    productFormVariationsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-variation-btn')) e.target.closest('.variation-option-group').remove(); if (e.target.classList.contains('add-option-btn')) addVariationOptionInput(e.target.previousElementSibling); if (e.target.classList.contains('remove-variation-group-btn')) e.target.closest('.variation-group').remove(); });
    document.getElementById('edit-product-btn').addEventListener('click', () => {
        const selectedKey = productSwitcher.value;
        if (!selectedKey) return;
        const product = products[selectedKey];
        document.getElementById('product-modal-title').textContent = 'Edit Product';
        productForm.reset();
        productFormVariationsContainer.innerHTML = '';
        document.getElementById('edit-product-key').value = selectedKey;
        document.getElementById('product-form-name').value = product.name;
        document.getElementById('product-form-description').value = product.description;
        document.getElementById('product-form-price').value = product.price;
        document.getElementById('product-form-original-price').value = product.originalPrice;
        document.getElementById('product-form-theme').value = product.theme || 'light';
        const isBundle = product.bundle || false;
        document.getElementById('product-form-bundle').checked = isBundle;
        const bundleOptionsContainer = document.getElementById('bundle-options-container');
        bundleOptionsContainer.style.display = isBundle ? 'block' : 'none';
        if (isBundle) { document.getElementById('product-form-bundle-price1').value = product.bundlePrices?.[0] || ''; document.getElementById('product-form-bundle-price2').value = product.bundlePrices?.[1] || ''; document.getElementById('product-form-bundle-price3').value = product.bundlePrices?.[2] || ''; document.getElementById('product-form-cta-headline').value = product.ctaHeadline || ''; document.getElementById('product-form-cta-subheadline').value = product.ctaSubheadline || ''; }
        document.getElementById('product-form-media-type').value = product.mediaType || 'image';
        document.getElementById('product-form-media-url').value = product.mediaUrl || '';
        for (let i = 2; i <= 4; i++) { document.getElementById(`product-form-image-${i}`).value = product.images?.[i-2] || ''; }
        if (product.variations) { for (const name in product.variations) { addVariationInputGroup(name, product.variations[name]); } }
        productModal.style.display = 'block';
        if (adminPanel.style.display === 'block') adminPanel.style.display = 'none';
    });
    document.getElementById('add-product-btn').addEventListener('click', () => { document.getElementById('product-modal-title').textContent = 'Add New Product'; productForm.reset(); productFormVariationsContainer.innerHTML = ''; document.getElementById('edit-product-key').value = ''; document.getElementById('bundle-options-container').style.display = 'none'; });
    document.getElementById('delete-product-btn').addEventListener('click', () => { const selectedKey = productSwitcher.value; if (!selectedKey || Object.keys(products).length <= 1) return; if (confirm(`Are you sure you want to delete ${products[selectedKey].name}?`)) { delete products[selectedKey]; saveState().then(() => { populateProductSwitcher(); renderProduct(Object.keys(products)[0]); alert('Product deleted.'); }); } });
    productForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const editKey = document.getElementById('edit-product-key').value;
        const images = Array.from({length: 3}, (_, i) => document.getElementById(`product-form-image-${i + 2}`).value.trim()).filter(Boolean);
        const variations = {};
        document.querySelectorAll('.variation-group').forEach(group => { const name = group.querySelector('.variation-name').value.trim(); if (name) { const options = Array.from(group.querySelectorAll('.variation-option-group')).map(optGroup => ({ option: optGroup.querySelector('.variation-option-name').value.trim(), price: optGroup.querySelector('.variation-option-price').value.trim() || null, image: optGroup.querySelector('.variation-option-image').value.trim() || null, })).filter(opt => opt.option); if (options.length > 0) variations[name] = options; } });
        const isBundleChecked = document.getElementById('product-form-bundle').checked;
        const productData = {
            name: document.getElementById('product-form-name').value, description: document.getElementById('product-form-description').value, price: document.getElementById('product-form-price').value, originalPrice: document.getElementById('product-form-original-price').value, theme: document.getElementById('product-form-theme').value, bundle: isBundleChecked,
            ctaHeadline: isBundleChecked ? document.getElementById('product-form-cta-headline').value : '', ctaSubheadline: isBundleChecked ? document.getElementById('product-form-cta-subheadline').value : '',
            bundlePrices: isBundleChecked ? [document.getElementById('product-form-bundle-price1').value, document.getElementById('product-form-bundle-price2').value, document.getElementById('product-form-bundle-price3').value] : [],
            mediaType: document.getElementById('product-form-media-type').value, mediaUrl: document.getElementById('product-form-media-url').value, images: images, variations: variations
        };
        const keyToSelect = editKey || `product${Date.now()}`;
        products[keyToSelect] = productData;
        saveState().then(() => { populateProductSwitcher(); productSwitcher.value = keyToSelect; renderProduct(keyToSelect); productModal.style.display = 'none'; if (document.body.dataset.isAdmin === 'true') adminPanel.style.display = 'block'; });
    });
    document.getElementById('product-form-bundle').addEventListener('change', (e) => { document.getElementById('bundle-options-container').style.display = e.target.checked ? 'block' : 'none'; });
    // SETTINGS
    function updateSectionVisibility() { shippingSection.style.display = settings.showShipping ? 'block' : 'none'; reviewsSection.style.display = settings.showReviews ? 'block' : 'none'; perksSection.style.display = settings.showPerks ? 'grid' : 'none'; customizationSection.style.display = settings.showCustomization ? 'block' : 'none'; toggleShipping.checked = settings.showShipping; toggleReviews.checked = settings.showReviews; togglePerks.checked = settings.showPerks; toggleCustomization.checked = settings.showCustomization; }
    // INIT
    async function initializeApp() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true') {
            adminPasswordModal.style.display = 'block';
            adminPasswordInput.focus();
        }
        await loadState();
        populateProductSwitcher();
        const initialProductKey = Object.keys(products)[0];
        if (initialProductKey) { productSwitcher.value = initialProductKey; renderProduct(initialProductKey); }
        renderCart();
        startCountdown();
        manageArtificialStock();
        startSocialProof();
    }
    // LISTENERS
    adminLoginLink.addEventListener('click', (e) => { e.preventDefault(); const currentUrl = new URL(window.location.href); currentUrl.searchParams.set('admin', 'true'); window.location.href = currentUrl.href; });
    adminPasswordSubmit.addEventListener('click', () => { if (adminPasswordInput.value === 'e55c3p') { document.body.dataset.isAdmin = 'true'; adminPasswordModal.style.display = 'none'; adminPanel.style.display = 'block'; pageContainer.classList.add('pt-20'); } else { adminPasswordError.style.display = 'block'; adminPasswordInput.value = ''; } });
    adminPasswordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') adminPasswordSubmit.click(); });
    hideAdminBtn.addEventListener('click', () => { adminPanel.style.display = 'none'; pageContainer.classList.remove('pt-20'); });
    logoutBtn.addEventListener('click', () => { document.body.dataset.isAdmin = 'false'; adminPanel.style.display = 'none'; pageContainer.classList.remove('pt-20'); });
    saveSettingsBtn.addEventListener('click', () => { settings.showShipping = toggleShipping.checked; settings.showReviews = toggleReviews.checked; settings.showPerks = togglePerks.checked; settings.showCustomization = toggleCustomization.checked; saveSettings(); updateSectionVisibility(); alert('Settings saved!'); });
    saveMediaBtn.addEventListener('click', () => { if (!currentProductKey) return; products[currentProductKey].mediaType = adminMediaType.value; products[currentProductKey].mediaUrl = adminMediaUrl.value; saveState().then(() => { renderProduct(currentProductKey); alert('Media saved!'); }); });
    document.getElementById('add-to-cart-button').addEventListener('click', addToCart);
    interactiveBundleSelector.addEventListener('change', updateBundleSummary);
    productSwitcher.addEventListener('change', (e) => renderProduct(e.target.value));
    popupContinueShopping.addEventListener('click', () => { clearTimeout(popupTimeout); addToCartPopup.style.display = 'none'; });
    popupViewCart.addEventListener('click', () => { clearTimeout(popupTimeout); addToCartPopup.style.display = 'none'; openCart(); });
    closePopupBtn.addEventListener('click', () => { clearTimeout(popupTimeout); addToCartPopup.style.display = 'none'; });
    const openCart = () => { cartPanel.classList.add('open'); cartOverlay.classList.add('open'); startCartTimer(); };
    publicCartButton.addEventListener('click', openCart);
    const closeCart = () => { cartPanel.classList.remove('open'); cartOverlay.classList.remove('open'); clearInterval(cartTimerInterval); };
    closeCartBtn.addEventListener('click', closeCart);
    cartOverlay.addEventListener('click', closeCart);
    cartItemsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { const itemElement = e.target.closest('[data-variant-id]'); cart = cart.filter(item => item.variantId !== itemElement.dataset.variantId); saveState(); renderCart(); } });
    checkoutBtn.addEventListener('click', async () => {
        if (cart.length === 0) { checkoutBtn.textContent = 'Your cart is empty!'; setTimeout(() => { checkoutBtn.textContent = 'Pay with Card'; }, 2000); return; }
        checkoutBtn.textContent = 'Connecting...';
        checkoutBtn.disabled = true;
        if (typeof fbq === 'function') { const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price.replace('$', '')) * item.quantity), 0); fbq('track', 'InitiateCheckout', { value: subtotal.toFixed(2), currency: 'USD', num_items: cart.reduce((sum, item) => sum + item.quantity, 0) }); }
        const newTab = window.open('', '_blank');
        newTab.document.body.innerHTML = "Connecting to secure checkout...";
        const line_items = cart.map(item => ({ price_data: { currency: 'usd', product_data: { name: `${item.name} (${item.variantText})`, images: [item.image] }, unit_amount: Math.round(parseFloat(item.price.replace('$', '')) * 100), }, quantity: item.quantity, }));
        try {
            const response = await fetch(CHECKOUT_SESSION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: line_items }), });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const { url } = await response.json();
            if (url) { newTab.location.href = url; } else { newTab.close(); throw new Error('Could not get checkout URL.'); }
        } catch (error) { console.error('Checkout error:', error); if (newTab) newTab.close(); } finally { checkoutBtn.textContent = 'Pay with Card'; checkoutBtn.disabled = false; }
    });
    document.getElementById('set-background-btn').addEventListener('click', () => { const bgUrl = document.getElementById('background-url-input').value; if (bgUrl) { document.body.style.backgroundImage = `url('${bgUrl}')`; settings.backgroundUrl = bgUrl; saveSettings(); } });
    initializeApp();
});
</script>
</body>
</html>
