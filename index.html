<script>
    // This is the full, final, and correct script.
    // Paste your keys and Vercel URL below.
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const LOGO_URL_WHITE = 'https://i.imgur.com/7B5NkbX.png';
        const LOGO_URL_BLACK = 'https://i.imgur.com/mY9JuRX.png';
        const STRIPE_PUBLISHABLE_KEY = 'YOUR_PUBLISHABLE_KEY_HERE';
        const CHECKOUT_SESSION_URL = 'YOUR_VERCEL_URL_HERE';
        const PRODUCTS_API_URL = '/api/products';
        const UPLOAD_API_URL = '/api/upload';

        // --- STATE ---
        let products = {}, reviews = {}, cart = [], currentProductKey = null, settings = {}, cartTimerInterval = null, popupTimeout = null;
        const appStateKey = 'urgentLandingPageState_v16';
        const settingsStateKey = 'urgentLandingPageSettings';
        const initialProducts = { product1: { name: 'Your First Product', description: 'Edit this product from the admin panel.', price: '$19.99', originalPrice: '$25.00', theme: 'light', mediaType: 'image', mediaUrl: 'https://placehold.co/600x600/ccc/ffffff?text=My+Product', images: [], variations: { 'Size': [{ option: 'M' }] }, bundle: false } };
        const initialReviews = { product1: [ { rating: 5, title: "Works Great!", text: "This is exactly what I needed.", author: "Jane D." } ] };

        // --- DOM ELEMENTS ---
        const dom = new Proxy({}, { get: (_, id) => document.getElementById(id.replace(/([A-Z])/g, "-$1").toLowerCase()) });

        // --- DATA & STATE FUNCTIONS ---
        async function saveState() {
            try {
                await fetch(PRODUCTS_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ products }) });
                localStorage.setItem(appStateKey, JSON.stringify({ cart }));
            } catch (error) { console.error("Failed to save products:", error); }
        }
        function saveSettings() { localStorage.setItem(settingsStateKey, JSON.stringify(settings)); }
        async function loadState() {
            try {
                const response = await fetch(PRODUCTS_API_URL); if (!response.ok) throw new Error('Failed to fetch'); const serverProducts = await response.json();
                products = (serverProducts && Object.keys(serverProducts).length > 0) ? serverProducts : initialProducts;
                const savedState = localStorage.getItem(appStateKey); cart = savedState ? JSON.parse(savedState).cart || [] : [];
            } catch (error) { console.error("Failed to load products:", error); products = initialProducts; cart = []; }
            const savedSettings = localStorage.getItem(settingsStateKey); settings = savedSettings ? JSON.parse(savedSettings) : { showSidebar: false, timerMode: 'refresh', defaultProduct: null };
        }

        // --- MODAL & UI FUNCTIONS ---
        function setupModal(modal, openBtn, closeBtnSelector, onCloseCallback = null) {
            if (!modal) return;
            const closeBtn = modal.querySelector(closeBtnSelector);
            const closeModal = () => {
                modal.style.display = 'none';
                if (onCloseCallback) onCloseCallback();
            };
            if (openBtn) openBtn.addEventListener('click', () => { modal.style.display = 'block'; });
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target == modal) closeModal(); });
        }
        function showItemAddedPopup(product, message) {
            clearTimeout(popupTimeout);
            dom.popupProductImage.src = product.mediaType === 'image' ? product.mediaUrl : (product.imageUrl || 'https://placehold.co/128x128');
            dom.popupMessage.innerHTML = message;
            dom.addToCartPopup.style.display = 'block';
            popupTimeout = setTimeout(() => { dom.addToCartPopup.style.display = 'none'; }, 5000);
        }

        // --- CART & PRODUCT FUNCTIONS ---
        function updateCartIcon() { const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0); dom.publicCartBadge.textContent = totalItems; }
        function renderCart() {
            dom.cartItemsContainer.innerHTML = ''; let subtotal = 0; const bundleGroups = {};
            cart.forEach(item => { const product = products[item.productId]; if (product && product.bundle) { if (!bundleGroups[item.productId]) bundleGroups[item.productId] = []; bundleGroups[item.productId].push(item); } });
            for (const productId in bundleGroups) {
                const items = bundleGroups[productId]; const product = products[productId]; const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', '')));
                items.forEach((item, index) => {
                    let price;
                    if (index === 0) price = bundlePrices[0];
                    else if (index === 1) price = bundlePrices[1];
                    else if (index === 2) price = bundlePrices[2];
                    else price = bundlePrices[1]; // Keep original pricing for 4th+ item
                    item.price = `$${price.toFixed(2)}`;
                });
            }
            if (cart.length === 0) { dom.cartItemsContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`; } else { cart.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'flex items-center space-x-4 py-3 border-b'; itemEl.dataset.variantId = item.variantId; const price = parseFloat(item.price.replace('$', '')); subtotal += price * item.quantity; itemEl.innerHTML = `<img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md"><div class="flex-grow"><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-500">${item.variantText}</p><p class="font-bold text-sm">${item.price}</p></div><div class="flex items-center space-x-2"><button class="remove-item-btn text-red-500 hover:text-red-700 font-bold text-xl px-2">&times;</button></div>`; dom.cartItemsContainer.appendChild(itemEl); }); }
            dom.cartSubtotal.textContent = `$${subtotal.toFixed(2)}`; updateCartIcon();
        }
        function addToCart() {
            const product = products[currentProductKey]; let price = parseFloat(product.price.replace('$', ''));
            if (product.bundle) {
                const selectedDesigns = Array.from(dom.interactiveBundleSelector.querySelectorAll('input:checked')).map(input => ({ name: input.value, image: input.dataset.image }));
                if (selectedDesigns.length === 0) { alert("Please select at least one design."); return; }
                selectedDesigns.forEach((design) => { cart.push({ productId: currentProductKey, variantId: `${currentProductKey}|${design.name}|${Date.now()}`, name: product.name, price: product.bundlePrices[0], image: design.image, variantText: design.name, quantity: 1 }); });
                showItemAddedPopup({ ...product, mediaUrl: selectedDesigns[0].image, mediaType: 'image' }, `Added <strong>${selectedDesigns.length} items</strong> to your cart!`);
            } else {
                let variantTextParts = [], variantIdParts = [currentProductKey], basePrice = product.price;
                dom.variationsContainer.querySelectorAll('select').forEach(select => { const sel = select.options[select.selectedIndex]; variantTextParts.push(sel.textContent.split(' (')[0]); variantIdParts.push(sel.textContent); if (sel.dataset.price) basePrice = sel.dataset.price; });
                const variantId = variantIdParts.join('|'); const existingItem = cart.find(item => item.variantId === variantId);
                if (existingItem) { existingItem.quantity++; } else { cart.push({ productId: currentProductKey, variantId, name: product.name, price: basePrice, image: product.mediaUrl, variantText: variantTextParts.join(', '), quantity: 1 }); }
                price = parseFloat(basePrice.replace('$', '')); showItemAddedPopup(product, `<strong>${product.name}</strong> added to cart!`);
            }
            if (typeof fbq === 'function') { fbq('track', 'AddToCart', { content_name: product.name, content_ids: [currentProductKey], content_type: 'product', value: price, currency: 'USD' }); }
            saveState(); renderCart();
        }
        function updateBundleSummary() {
            const selectedInputs = Array.from(dom.interactiveBundleSelector.querySelectorAll('input:checked')); const product = products[currentProductKey]; if (!product || !product.bundlePrices) return; const bundlePrices = product.bundlePrices.map(p => parseFloat(p.replace('$', ''))); let total = 0; let originalTotal = 0; dom.bundleSummaryItems.innerHTML = '';
            if (selectedInputs.length > 0) {
                dom.bundleSummary.style.display = 'block';
                selectedInputs.forEach((input, index) => {
                    let price;
                    if (index === 0) price = bundlePrices[0];
                    else if (index === 1) price = bundlePrices[1];
                    else if (index === 2) price = bundlePrices[2];
                    else price = bundlePrices[1]; // Keep original pricing for 4th+ item
                    total += price; originalTotal += parseFloat(product.originalPrice.replace('$', '')); const itemEl = document.createElement('div'); itemEl.className = 'flex justify-between items-center text-sm'; itemEl.innerHTML = `<span>Item ${index + 1}: ${input.value}</span><span class="font-bold">$${price.toFixed(2)}</span>`; dom.bundleSummaryItems.appendChild(itemEl);
                });
            } else { dom.bundleSummary.style.display = 'none'; }
            dom.productPrice.textContent = `$${total.toFixed(2)}`; dom.productOriginalPrice.textContent = `$${originalTotal.toFixed(2)}`;
        }
        function populateProductSwitcher() { dom.productSwitcher.innerHTML = ''; Object.keys(products).forEach(key => { const option = document.createElement('option'); option.value = key; option.textContent = products[key].name; dom.productSwitcher.appendChild(option); }); }
        function renderReviews(productId) {
            const productReviews = reviews[productId] || initialReviews[productId] || []; dom.reviewContainer.innerHTML = '';
            productReviews.forEach(review => { const reviewEl = document.createElement('div'); reviewEl.className = 'border-b pb-4 last:border-b-0'; const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating); reviewEl.innerHTML = `<div class="flex items-center mb-2"><span class="text-yellow-500">${stars}</span><strong class="ml-2 text-gray-800">${review.title}</strong></div><p class="text-gray-700">"${review.text}"</p><p class="text-sm text-gray-500 mt-2">- ${review.author}</p>`; dom.reviewContainer.appendChild(reviewEl); });
        }
        function renderProductSidebar() {
            dom.sidebarContent.innerHTML = '';
            Object.keys(products).filter(key => key !== currentProductKey).forEach(key => {
                const product = products[key]; const productEl = document.createElement('div'); productEl.className = 'cursor-pointer p-2 rounded-lg hover:bg-gray-200';
                productEl.innerHTML = `<img src="${product.mediaUrl || 'https://placehold.co/100x100'}" class="w-full h-24 object-cover rounded-md mb-2"><p class="text-sm font-semibold text-gray-800">${product.name}</p>`;
                productEl.addEventListener('click', () => renderProduct(key)); dom.sidebarContent.appendChild(productEl);
            });
        }
        function renderProduct(productKey) {
            currentProductKey = productKey; const product = products[productKey]; if (!product) return; document.body.dataset.theme = product.theme || 'light';
            dom.headerLogo.src = product.theme === 'light' ? LOGO_URL_BLACK : LOGO_URL_WHITE;
            dom.productName.textContent = product.name; dom.productDescription.textContent = product.description; dom.mainProductVideoContainer.innerHTML = '';
            if (product.mediaType === 'video' && product.mediaUrl) {
                dom.mainProductImage.style.display = 'none'; dom.mainProductVideoContainer.style.display = 'block'; const videoId = (product.mediaUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/) || [])[1]; if (videoId) dom.mainProductVideoContainer.innerHTML = `<iframe class="w-full h-full aspect-video" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            } else { dom.mainProductImage.style.display = 'block'; dom.mainProductVideoContainer.style.display = 'none'; dom.mainProductImage.src = product.mediaUrl || 'https://placehold.co/600x600/ccc/ffffff?text=No+Image'; }
            if (product.bundle) {
                dom.urgentCta.style.display = 'block'; dom.ctaHeadline.textContent = product.ctaHeadline || 'Build Your Bundle & Save Big!'; dom.ctaSubheadline.textContent = product.ctaSubheadline || 'Select items to unlock massive discounts!'; dom.variationsContainer.style.display = 'none'; dom.interactiveBundleSelector.style.display = 'block'; dom.productBadge.textContent = 'Limited Edition Bundle Deal';
                dom.interactiveBundleSelector.innerHTML = '<h4 class="font-bold text-lg text-gray-800 mb-2">Build Your Bundle & Save!</h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>'; const gridContainer = dom.interactiveBundleSelector.querySelector('.grid'); const designKey = Object.keys(product.variations)[0];
                if (designKey) {
                    product.variations[designKey].forEach(variation => { const optionId = `bundle-opt-${variation.option.replace(/\s+/g, '-')}`; const optionEl = document.createElement('div'); optionEl.className = 'bundle-image-option'; optionEl.innerHTML = `<input type="checkbox" id="${optionId}" value="${variation.option}" data-image="${variation.image}" class="sr-only"><label for="${optionId}" class="block relative border-2 border-gray-200 rounded-lg cursor-pointer transition-all p-1"><img src="${variation.image}" class="w-full h-24 object-cover rounded-md"><p class="text-center text-sm font-semibold mt-1">${variation.option}</p><div class="bundle-checkmark absolute top-1 right-1 h-6 w-6 bg-white/70 rounded-full flex items-center justify-center opacity-0 transform scale-75"><svg class="h-4 w-4 text-white" style="fill: var(--color-accent);" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"/></svg></div></label>`; gridContainer.appendChild(optionEl); optionEl.querySelector('label').addEventListener('click', () => { if (product.mediaType === 'image' || product.mediaType === 'video') { dom.mainProductImage.style.display = 'block'; dom.mainProductVideoContainer.style.display = 'none'; dom.mainProductImage.src = variation.image; } }); });
                }
                const firstBundleOption = dom.interactiveBundleSelector.querySelector('input[type="checkbox"]'); if (firstBundleOption) firstBundleOption.checked = true; updateBundleSummary();
            } else {
                dom.urgentCta.style.display = 'none'; dom.interactiveBundleSelector.style.display = 'none'; dom.bundleSummary.style.display = 'none'; dom.variationsContainer.style.display = 'block'; dom.productBadge.textContent = 'Limited Edition'; dom.productPrice.textContent = product.price; dom.productOriginalPrice.textContent = product.originalPrice; dom.variationsContainer.innerHTML = ''; if (product.variations) { for (const variationName in product.variations) { const options = product.variations[variationName]; if (options && options.length > 0) { const variationWrapper = document.createElement('div'); const label = document.createElement('label'); label.htmlFor = `variation-${variationName}`; label.className = 'block text-sm font-medium text-gray-700'; label.textContent = variationName; const select = document.createElement('select'); select.id = `variation-${variationName}`; select.className = 'mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md'; options.forEach(optionData => { const option = document.createElement('option'); let text = optionData.option; if (optionData.price) { text += ` (${optionData.price})`; option.dataset.price = optionData.price; } option.textContent = text; select.appendChild(option); }); variationWrapper.appendChild(label); variationWrapper.appendChild(select); dom.variationsContainer.appendChild(variationWrapper); } } }
            }
            renderReviews(productKey); updateSectionVisibility(); renderProductSidebar();
        }

        // --- TIMERS & DYNAMIC CONTENT ---
        let countdownInterval = null;
        function startCartTimer() { clearInterval(cartTimerInterval); let duration = 600; const timerEl = dom.cartTimer; cartTimerInterval = setInterval(() => { let minutes = parseInt(duration / 60, 10); let seconds = parseInt(duration % 60, 10); minutes = minutes < 10 ? "0" + minutes : minutes; seconds = seconds < 10 ? "0" + seconds : seconds; timerEl.textContent = `${minutes}:${seconds}`; if (--duration < 0) { clearInterval(cartTimerInterval); timerEl.textContent = "Expired!"; } }, 1000); }
        function startCountdown() {
            clearInterval(countdownInterval);
            const updateTimer = (duration) => { if (duration <= 0) { dom.countdownTimer.textContent = "00:00:00"; return; } const h = String(Math.floor(duration / 3600)).padStart(2, '0'); const m = String(Math.floor((duration % 3600) / 60)).padStart(2, '0'); const s = String(duration % 60).padStart(2, '0'); dom.countdownTimer.textContent = `${h}:${m}:${s}`; };
            if (settings.timerMode === 'actual' && settings.actualEndDate) {
                const endDate = new Date(settings.actualEndDate).getTime(); updateTimer(Math.floor((endDate - new Date().getTime()) / 1000));
                countdownInterval = setInterval(() => { const now = new Date().getTime(); const remaining = Math.floor((endDate - now) / 1000); if (remaining <= 0) { clearInterval(countdownInterval); } updateTimer(remaining); }, 1000);
            } else {
                let duration = 120; // Keep timer at 2 minutes
                updateTimer(duration);
                countdownInterval = setInterval(() => { duration--; if (duration <= 0) { clearInterval(countdownInterval); } updateTimer(duration); }, 1000);
            }
        }
        function manageArtificialStock() { let stock = 12; dom.stockCount.textContent = stock; const stockTimer = setInterval(() => { if (stock > 2) { stock--; dom.stockCount.textContent = stock; } else { clearInterval(stockTimer); } }, 20000); }
        function startSocialProof() { const locations = ["Miami, FL", "Tampa, FL", "Los Angeles, CA", "Houston, TX", "New York, NY", "Phoenix, AZ", "Chicago, IL"]; const popup = dom.socialProofPopup; setInterval(() => { if (!currentProductKey) return; const loc = locations[Math.floor(Math.random() * locations.length)]; const prod = products[currentProductKey]; const name = prod.name.split(' ').slice(0, 2).join(' '); popup.innerHTML = `🔥 Someone from <b>${loc}</b> just purchased a ${name}!`; popup.classList.add('show'); setTimeout(() => { popup.classList.remove('show'); }, 5000); }, 15000); }
        
        // --- ADMIN FORM FUNCTIONS ---
        const addVariationOptionInput = function (container, option = {}) { const wrapper = document.createElement('div'); wrapper.className = 'variation-option-group grid grid-cols-12 gap-2 items-start border-t pt-2 mt-2'; wrapper.innerHTML = `<div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Option Name</label><input type="text" value="${option.option || ''}" placeholder="e.g., Red" class="variation-option-name w-full border p-2 rounded"></div><div class="col-span-3"><label class="block text-sm font-medium text-gray-700">Price (Optional)</label><input type="text" value="${option.price || ''}" placeholder="$35.00" class="variation-option-price w-full border p-2 rounded"></div><div class="col-span-5"> <label class="block text-sm font-medium text-gray-700">Image</label> <input type="file" class="variation-option-image-file block w-full text-sm mb-1"> <div class="flex"><input type="text" placeholder="Or paste URL..." value="${option.image || ''}" class="variation-option-image-url w-full border p-1 rounded-l text-sm"><button type="button" class="update-variation-image-btn bg-gray-200 px-2 rounded-r text-xs">Preview</button></div></div><div class="col-span-1 flex flex-col items-center"><img src="${option.image || 'https://placehold.co/100x100/eee/ccc?text=Img'}" class="variation-image-preview h-12 w-12 object-cover rounded mb-2"><button type="button" class="remove-variation-btn text-red-500 font-bold text-lg">X</button></div>`; container.appendChild(wrapper); };
        const addVariationInputGroup = function (name = '', options = []) { const groupWrapper = document.createElement('div'); groupWrapper.className = 'variation-group border p-3 rounded-md'; const variationId = `var-group-${Date.now()}`; groupWrapper.innerHTML = `<div class="grid grid-cols-12 gap-2 items-center"><input type="text" value="${name}" placeholder="Variation Name (e.g., Size)" class="variation-name col-span-11 border p-2 rounded"><button type="button" class="remove-variation-group-btn col-span-1 text-red-500 font-bold">X</button></div><div id="${variationId}" class="options-container mt-2 space-y-2"></div><button type="button" class="add-option-btn mt-2 text-sm text-indigo-600 font-semibold">+ Add Option</button>`; dom.productFormVariationsContainer.appendChild(groupWrapper); const optionsContainer = document.getElementById(variationId); if (options.length > 0) { options.forEach(opt => addVariationOptionInput(optionsContainer, opt)); } else { addVariationOptionInput(optionsContainer); } };
        function updateSectionVisibility() { dom.productSidebar.classList.toggle('show', settings.showSidebar); dom.toggleSidebar.checked = settings.showSidebar; dom.timerModeSelect.value = settings.timerMode || 'refresh'; dom.timerActualDate.value = settings.actualEndDate || ''; dom.timerModeSelect.dispatchEvent(new Event('change')); }

        // --- INITIALIZATION ---
        async function initializeApp() {
            // FIX: Add callback to restore admin panel after product modal closes
            const productModalCloseCallback = () => {
                if (document.body.dataset.isAdmin === 'true') {
                    dom.adminPanel.style.display = 'block';
                }
            };
            setupModal(dom.productModal, null, '.close-product-modal', productModalCloseCallback);
            setupModal(dom.addToCartPopup, null, '.close-modal');
            setupModal(dom.adminPasswordModal, null, '.close-modal');
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true') { dom.adminPasswordModal.style.display = 'block'; dom.adminPasswordInput.focus(); }
            
            await loadState();
            populateProductSwitcher();
            const defaultProduct = settings.defaultProduct || Object.keys(products)[0];
            if (products[defaultProduct]) { dom.productSwitcher.value = defaultProduct; renderProduct(defaultProduct); }
            
            renderCart(); startCountdown(); manageArtificialStock(); startSocialProof();
        }

        // --- EVENT LISTENERS ---
        dom.adminLoginLink.addEventListener('click', (e) => { e.preventDefault(); const url = new URL(window.location.href); url.searchParams.set('admin', 'true'); window.location.href = url.href; });
        dom.adminPasswordSubmit.addEventListener('click', () => { if (dom.adminPasswordInput.value === 'e55c3p') { document.body.dataset.isAdmin = 'true'; dom.adminPasswordModal.style.display = 'none'; dom.adminPanel.style.display = 'block'; } else { dom.adminPasswordError.style.display = 'block'; dom.adminPasswordInput.value = ''; } });
        dom.adminPasswordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') dom.adminPasswordSubmit.click(); });
        dom.hideAdminBtn.addEventListener('click', () => { dom.adminPanel.style.display = 'none'; });
        dom.logoutBtn.addEventListener('click', () => { document.body.dataset.isAdmin = 'false'; dom.adminPanel.style.display = 'none'; });
        dom.saveSettingsBtn.addEventListener('click', () => { settings = { showSidebar: dom.toggleSidebar.checked, timerMode: dom.timerModeSelect.value, actualEndDate: dom.timerActualDate.value, defaultProduct: settings.defaultProduct }; saveSettings(); updateSectionVisibility(); startCountdown(); alert('Settings saved!'); });
        dom.setDefaultBtn.addEventListener('click', () => { settings.defaultProduct = dom.productSwitcher.value; saveSettings(); alert('Default product set!'); });
        dom.timerModeSelect.addEventListener('change', (e) => { dom.timerActualDate.style.display = e.target.value === 'actual' ? 'block' : 'none'; });
        dom.addToCartButton.addEventListener('click', addToCart);
        dom.productSwitcher.addEventListener('change', (e) => renderProduct(e.target.value));
        dom.popupContinueShopping.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; });
        dom.popupViewCart.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; openCart(); });
        dom.closePopupBtn.addEventListener('click', () => { clearTimeout(popupTimeout); dom.addToCartPopup.style.display = 'none'; });
        const openCart = () => { dom.cartPanel.classList.add('open'); dom.cartOverlay.classList.add('open'); startCartTimer(); };
        dom.publicCartButton.addEventListener('click', openCart);
        const closeCart = () => { dom.cartPanel.classList.remove('open'); dom.cartOverlay.classList.remove('open'); clearInterval(cartTimerInterval); };
        dom.closeCartBtn.addEventListener('click', closeCart);
        dom.cartOverlay.addEventListener('click', closeCart);
        dom.cartItemsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-item-btn')) { const itemEl = e.target.closest('[data-variant-id]'); cart = cart.filter(item => item.variantId !== itemEl.dataset.variantId); saveState(); renderCart(); } });
        dom.checkoutBtn.addEventListener('click', async () => {
            if (cart.length === 0) { dom.checkoutBtn.textContent = 'Your cart is empty!'; setTimeout(() => { dom.checkoutBtn.textContent = 'Pay with Card'; }, 2000); return; }
            dom.checkoutBtn.textContent = 'Connecting...'; dom.checkoutBtn.disabled = true;
            if (typeof fbq === 'function') { const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price.replace('$', '')) * item.quantity), 0); fbq('track', 'InitiateCheckout', { value: subtotal.toFixed(2), currency: 'USD', num_items: cart.reduce((sum, item) => sum + item.quantity, 0) }); }
            const newTab = window.open('', '_blank'); newTab.document.body.innerHTML = "Connecting to secure checkout...";
            const line_items = cart.map(item => ({ price_data: { currency: 'usd', product_data: { name: `${item.name} (${item.variantText})`, images: [item.image] }, unit_amount: Math.round(parseFloat(item.price.replace('$', '')) * 100), }, quantity: item.quantity, }));
            try {
                const response = await fetch(CHECKOUT_SESSION_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: line_items }), });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const { url } = await response.json();
                if (url) { newTab.location.href = url; } else { newTab.close(); throw new Error('Could not get checkout URL.'); }
            } catch (error) { console.error('Checkout error:', error); if (newTab) newTab.close(); } finally { dom.checkoutBtn.textContent = 'Pay with Card'; dom.checkoutBtn.disabled = false; }
        });
        dom.addVariationBtn.addEventListener('click', () => addVariationInputGroup());
        dom.productFormVariationsContainer.addEventListener('click', (e) => { if (e.target.classList.contains('remove-variation-btn')) e.target.closest('.variation-option-group').remove(); if (e.target.classList.contains('add-option-btn')) addVariationOptionInput(e.target.previousElementSibling); if (e.target.classList.contains('remove-variation-group-btn')) e.target.closest('.variation-group').remove(); if (e.target.classList.contains('update-variation-image-btn')) { const group = e.target.closest('.variation-option-group'); const urlInput = group.querySelector('.variation-option-image-url'); const previewImg = group.querySelector('.variation-image-preview'); if (urlInput.value) previewImg.src = urlInput.value; } });
        dom.editProductBtn.addEventListener('click', () => {
            const selectedKey = dom.productSwitcher.value; if (!selectedKey) return; const product = products[selectedKey];
            dom.productModalTitle.textContent = 'Edit Product'; dom.productForm.reset(); dom.productFormVariationsContainer.innerHTML = ''; dom.editProductKey.value = selectedKey; dom.productFormName.value = product.name; dom.productFormDescription.value = product.description; dom.productFormPrice.value = product.price; dom.productFormOriginalPrice.value = product.originalPrice; dom.productFormTheme.value = product.theme || 'light';
            const isBundle = product.bundle || false; dom.productFormBundle.checked = isBundle; dom.bundleOptionsContainer.style.display = isBundle ? 'block' : 'none';
            if (isBundle) { dom.productFormBundlePrice1.value = product.bundlePrices?.[0] || ''; dom.productFormBundlePrice2.value = product.bundlePrices?.[1] || ''; dom.productFormBundlePrice3.value = product.bundlePrices?.[2] || ''; dom.productFormCtaHeadline.value = product.ctaHeadline || ''; dom.productFormCtaSubheadline.value = product.ctaSubheadline || ''; }
            dom.productFormMediaType.value = product.mediaType || 'image'; dom.productFormMediaType.dispatchEvent(new Event('change'));
            if (product.mediaType === 'video') dom.productFormMediaUrl.value = product.mediaUrl || '';
            if (product.variations) { for (const name in product.variations) { addVariationInputGroup(name, product.variations[name]); } }
            dom.productModal.style.display = 'block'; if (dom.adminPanel.style.display === 'block') dom.adminPanel.style.display = 'none';
        });
        dom.addProductBtn.addEventListener('click', () => {
            dom.productModalTitle.textContent = 'Add New Product'; dom.productForm.reset(); dom.productFormVariationsContainer.innerHTML = ''; dom.editProductKey.value = ''; dom.bundleOptionsContainer.style.display = 'none';
            dom.productModal.style.display = 'block'; if (dom.adminPanel.style.display === 'block') dom.adminPanel.style.display = 'none';
        });
        dom.productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = dom.productFormSubmit; submitButton.disabled = true; submitButton.textContent = 'Uploading...';
            const uploadFile = async (fileInput) => {
                if (!fileInput || !fileInput.files[0]) return null;
                const file = fileInput.files[0];
                const response = await fetch(`${UPLOAD_API_URL}?filename=${file.name}`, { method: 'POST', headers: { 'x-filename': file.name }, body: file });
                if (!response.ok) { const errorText = await response.text(); throw new Error(`Upload failed: ${errorText}`); }
                const newBlob = await response.json(); return newBlob.url;
            };
            try {
                let mainMediaUrl = dom.productFormMediaUrl.value; if (dom.productFormMediaType.value === 'image' && dom.productFormMediaFile.files[0]) { mainMediaUrl = await uploadFile(dom.productFormMediaFile); }
                const isBundle = dom.productFormBundle.checked;
                const productData = { name: dom.productFormName.value, description: dom.productFormDescription.value, price: dom.productFormPrice.value, originalPrice: dom.productFormOriginalPrice.value, theme: dom.productFormTheme.value, bundle: isBundle, ctaHeadline: isBundle ? dom.productFormCtaHeadline.value : '', ctaSubheadline: isBundle ? dom.productFormCtaSubheadline.value : '', bundlePrices: isBundle ? [dom.productFormBundlePrice1.value, dom.productFormBundlePrice2.value, dom.productFormBundlePrice3.value] : [], mediaType: dom.productFormMediaType.value, mediaUrl: mainMediaUrl, images: [], variations: {} };
                const variationGroups = Array.from(dom.productFormVariationsContainer.querySelectorAll('.variation-group'));
                for (const group of variationGroups) {
                    const name = group.querySelector('.variation-name').value.trim();
                    if (name) {
                        const options = [];
                        const optionGroups = Array.from(group.querySelectorAll('.variation-option-group'));
                        for (const optGroup of optionGroups) {
                            const fileInput = optGroup.querySelector('.variation-option-image-file');
                            const urlInput = optGroup.querySelector('.variation-option-image-url');
                            let imageUrl = optGroup.querySelector('.variation-image-preview').src;
                            if (fileInput.files[0]) { imageUrl = await uploadFile(fileInput); } else if (urlInput.value && urlInput.value !== imageUrl) { imageUrl = urlInput.value; }
                            options.push({ option: optGroup.querySelector('.variation-option-name').value.trim(), price: optGroup.querySelector('.variation-option-price').value.trim() || null, image: imageUrl });
                        }
                        productData.variations[name] = options.filter(opt => opt.option);
                    }
                }
                const keyToSelect = dom.editProductKey.value || `product${Date.now()}`;
                products[keyToSelect] = productData;
                submitButton.textContent = 'Saving...';
                await saveState();
                populateProductSwitcher(); dom.productSwitcher.value = keyToSelect; renderProduct(keyToSelect); dom.productModal.style.display = 'none';
            } catch (error) { console.error("Failed to save product:", error); alert("Error saving product. Check console."); } finally { submitButton.disabled = false; submitButton.textContent = 'Save Product'; }
        });

        initializeApp();
    });
</script>
